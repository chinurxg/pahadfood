<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Pahad Food</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #2d2d2d;
  --accent: #ff6b35;
  --accent-light: #ff8556;
  --bg: #fafafa;
  --card-bg: #ffffff;
  --text-secondary: #666;
  --border: #e5e5e5;
  --shadow: 0 2px 8px rgba(0,0,0,0.06);
  --shadow-lg: 0 4px 24px rgba(0,0,0,0.1);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body { 
  font-family: 'DM Sans', sans-serif; 
  background: var(--bg); 
  color: var(--primary); 
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

/* Header */
.header { 
  background: var(--card-bg);
  padding: 16px 20px;
  box-shadow: var(--shadow);
  position: sticky;
  top: 0;
  z-index: 200;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.header h1 { 
  font-family: 'DM Serif Display', serif; 
  font-size: 24px;
  letter-spacing: 0.5px;
  color: var(--primary);
}

.header-location {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--text-secondary);
  cursor: pointer;
}

.header-location svg {
  width: 16px;
  height: 16px;
}

/* Container */
.container { 
  max-width: 480px; 
  margin: 0 auto; 
  padding-bottom: 80px;
}

/* City Selection */
.city-selection {
  padding: 32px 20px;
  text-align: center;
}

.city-selection h2 {
  font-family: 'DM Serif Display', serif;
  font-size: 28px;
  margin-bottom: 8px;
  color: var(--primary);
}

.city-selection p {
  font-size: 15px;
  color: var(--text-secondary);
  margin-bottom: 24px;
}

.city-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  padding: 0 20px;
}

.city-card {
  background: var(--card-bg);
  border: 2px solid var(--border);
  border-radius: 12px;
  padding: 20px 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: center;
}

.city-card:active {
  transform: scale(0.97);
}

.city-card.selected {
  border-color: var(--accent);
  background: linear-gradient(135deg, var(--accent), var(--accent-light));
  color: white;
}

.city-card-icon {
  width: 40px;
  height: 40px;
  margin: 0 auto 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg);
  border-radius: 50%;
}

.city-card.selected .city-card-icon {
  background: rgba(255,255,255,0.2);
}

.city-card h3 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 4px;
}

.city-card.selected h3,
.city-card.selected p {
  color: white;
}

.city-card p {
  font-size: 13px;
  color: var(--text-secondary);
}

/* Map View */
.map-container {
  position: relative;
  height: 400px;
  background: linear-gradient(180deg, #e8f5e9 0%, #c8e6c9 100%);
  overflow: hidden;
  touch-action: pan-x pan-y;
  user-select: none;
}

.map-wrapper {
  position: relative;
  width: 200%;
  height: 200%;
  transform-origin: center;
  transition: transform 0.15s ease-out;
}

.map-grid {
  position: absolute;
  inset: 0;
  background-image: 
    repeating-linear-gradient(0deg, rgba(76, 175, 80, 0.05) 0px, transparent 1px, transparent 40px),
    repeating-linear-gradient(90deg, rgba(76, 175, 80, 0.05) 0px, transparent 1px, transparent 40px);
}

.map-roads {
  position: absolute;
  inset: 0;
}

.road {
  position: absolute;
  background: rgba(158, 158, 158, 0.3);
  border-radius: 2px;
}

.road.horizontal {
  height: 16px;
  width: 100%;
  left: 0;
}

.road.vertical {
  width: 16px;
  height: 100%;
  top: 0;
}

.map-chef {
  position: absolute;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.map-chef:active {
  transform: scale(1.1);
}

.chef-marker {
  width: 64px;
  height: 80px;
  position: relative;
}

.chef-building {
  width: 64px;
  height: 64px;
  background: linear-gradient(135deg, #ff6b35, #ff8556);
  border-radius: 8px 8px 4px 4px;
  box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 3px solid white;
}

.chef-building::before {
  content: '';
  position: absolute;
  top: -8px;
  left: 8px;
  right: 8px;
  height: 12px;
  background: linear-gradient(135deg, #ff8556, #ffa577);
  border-radius: 4px 4px 0 0;
}

.chef-building svg {
  width: 28px;
  height: 28px;
  color: white;
  position: relative;
  z-index: 1;
}

.chef-name {
  position: absolute;
  bottom: -20px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  color: var(--primary);
}

.map-instructions {
  position: absolute;
  top: 16px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.95);
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 13px;
  color: var(--primary);
  font-weight: 500;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  gap: 6px;
  z-index: 10;
}

.map-instructions svg {
  width: 16px;
  height: 16px;
}

/* Menu Grid */
.menu-header {
  padding: 20px 20px 12px;
  background: var(--card-bg);
  border-bottom: 1px solid var(--border);
}

.menu-header h2 {
  font-family: 'DM Serif Display', serif;
  font-size: 22px;
  margin-bottom: 4px;
}

.menu-header p {
  font-size: 14px;
  color: var(--text-secondary);
}

.menu-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  padding: 12px;
}

.menu-card {
  background: var(--card-bg);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--shadow);
  position: relative;
}

.menu-card-img {
  width: 100%;
  height: 120px;
  object-fit: cover;
  background: linear-gradient(135deg, #f5f5f5, #e5e5e5);
}

.menu-card-content {
  padding: 10px;
}

.menu-card-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 4px;
  line-height: 1.3;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.menu-card-price {
  font-size: 15px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 8px;
}

.menu-card-controls {
  display: flex;
  gap: 6px;
  align-items: center;
}

.qty-btn {
  width: 32px;
  height: 32px;
  border: none;
  background: var(--accent);
  color: white;
  border-radius: 8px;
  cursor: pointer;
  font-size: 18px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.qty-btn:active {
  transform: scale(0.92);
}

.qty-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.qty-btn.minus {
  background: var(--border);
  color: var(--primary);
}

.qty-display {
  flex: 1;
  text-align: center;
  font-weight: 600;
  font-size: 15px;
}

.item-badge {
  position: absolute;
  top: 8px;
  right: 8px;
  background: var(--accent);
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 700;
  box-shadow: 0 2px 8px rgba(255, 107, 53, 0.4);
}

/* Cart Bar */
.cart-bar {
  position: fixed;
  bottom: 64px;
  left: 0;
  right: 0;
  background: var(--card-bg);
  border-top: 1px solid var(--border);
  padding: 12px 16px;
  z-index: 100;
  box-shadow: 0 -4px 16px rgba(0,0,0,0.08);
}

.cart-bar.hidden {
  display: none;
}

.cart-summary {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 13px;
  color: var(--text-secondary);
}

.cart-action {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.cart-total {
  font-size: 20px;
  font-weight: 700;
  color: var(--primary);
}

.btn-primary {
  flex: 1;
  padding: 14px 24px;
  background: linear-gradient(135deg, var(--accent), var(--accent-light));
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
  transition: all 0.2s;
}

.btn-primary:active {
  transform: scale(0.97);
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Bottom Nav */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card-bg);
  border-top: 1px solid var(--border);
  display: flex;
  z-index: 101;
  padding: 8px 0;
}

.nav-item {
  flex: 1;
  padding: 8px;
  text-align: center;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  color: var(--text-secondary);
  transition: color 0.2s;
}

.nav-item svg {
  width: 22px;
  height: 22px;
}

.nav-item span {
  font-size: 11px;
  font-weight: 500;
}

.nav-item.active {
  color: var(--accent);
}

/* Checkout */
.checkout {
  padding: 20px;
  padding-bottom: 80px;
}

.checkout h2 {
  font-family: 'DM Serif Display', serif;
  font-size: 24px;
  margin-bottom: 16px;
}

.order-summary {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
}

.order-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  font-size: 14px;
}

.order-total {
  border-top: 2px solid var(--border);
  padding-top: 12px;
  margin-top: 12px;
  font-size: 18px;
  font-weight: 700;
}

.form-section {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--primary);
}

.form-input {
  width: 100%;
  padding: 14px;
  border: 2px solid var(--border);
  border-radius: 12px;
  font-size: 15px;
  font-family: inherit;
  transition: border-color 0.2s;
}

.form-input:focus {
  outline: none;
  border-color: var(--accent);
}

.form-textarea {
  width: 100%;
  padding: 14px;
  border: 2px solid var(--border);
  border-radius: 12px;
  font-size: 15px;
  font-family: inherit;
  resize: vertical;
  min-height: 80px;
}

.form-textarea:focus {
  outline: none;
  border-color: var(--accent);
}

.delivery-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 20px;
}

.delivery-option {
  background: var(--card-bg);
  border: 2px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
}

.delivery-option:active {
  transform: scale(0.97);
}

.delivery-option.selected {
  border-color: var(--accent);
  background: linear-gradient(135deg, rgba(255,107,53,0.1), rgba(255,133,86,0.1));
}

.delivery-option-icon {
  width: 32px;
  height: 32px;
  margin: 0 auto 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.delivery-option h4 {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 4px;
}

.delivery-option p {
  font-size: 13px;
  color: var(--text-secondary);
}

.price-breakdown {
  background: var(--bg);
  border-radius: 12px;
  padding: 16px;
  margin: 20px 0;
}

.price-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  font-size: 15px;
}

.price-row.total {
  border-top: 2px solid var(--border);
  padding-top: 12px;
  margin-top: 8px;
  font-size: 18px;
  font-weight: 700;
}

.btn-secondary {
  width: 100%;
  padding: 14px;
  background: white;
  color: var(--primary);
  border: 2px solid var(--border);
  border-radius: 12px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  margin-top: 12px;
}

.btn-secondary:active {
  transform: scale(0.98);
}

/* Orders */
.orders-container {
  padding: 20px;
  padding-bottom: 80px;
}

.order-card {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: var(--shadow);
}

.order-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.order-id {
  font-weight: 700;
  font-size: 15px;
}

.order-status {
  display: inline-block;
  padding: 6px 12px;
  background: linear-gradient(135deg, #4caf50, #66bb6a);
  color: white;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.order-items {
  margin: 12px 0;
  padding: 12px 0;
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}

.order-item-row {
  font-size: 14px;
  color: var(--text-secondary);
  margin: 4px 0;
}

.order-total-row {
  font-size: 17px;
  font-weight: 700;
  margin-top: 8px;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
}

.empty-state svg {
  width: 64px;
  height: 64px;
  color: var(--text-secondary);
  opacity: 0.3;
  margin-bottom: 16px;
}

.empty-state h3 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--primary);
}

.empty-state p {
  font-size: 14px;
  color: var(--text-secondary);
}

/* Toast */
.toast {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--primary);
  color: white;
  padding: 12px 24px;
  border-radius: 12px;
  z-index: 1000;
  display: none;
  box-shadow: var(--shadow-lg);
  font-weight: 500;
}

/* Loading */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(250, 250, 250, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 500;
}

.loader {
  width: 48px;
  height: 48px;
  border: 4px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.hidden {
  display: none !important;
}
</style>
</head>
<body>

<div class="header">
  <h1>Pahad Food</h1>
  <div class="header-location" onclick="resetCity()">
    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
    </svg>
    <span id="headerLocation">Select City</span>
  </div>
</div>

<div id="app"></div>

<div id="cartBar" class="cart-bar hidden">
  <div class="cart-summary" id="cartSummary"></div>
  <div class="cart-action">
    <div class="cart-total" id="cartTotal">₹0</div>
    <button class="btn-primary" onclick="checkout()" id="checkoutBtn">Checkout</button>
  </div>
</div>

<div class="bottom-nav">
  <div class="nav-item active" onclick="switchTab('menu')">
    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path d="M3 6h18M3 12h18M3 18h18"/>
    </svg>
    <span>Menu</span>
  </div>
  <div class="nav-item" onclick="switchTab('processing')">
    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
    </svg>
    <span>Orders</span>
  </div>
  <div class="nav-item" onclick="switchTab('history')">
    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
    </svg>
    <span>Profile</span>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="loading-overlay hidden" id="loadingOverlay">
  <div class="loader"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';

const supabase = window.supabase.createClient(
  'https://zjuugofcrnieigciaclb.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqdXVnb2Zjcm5pZWlnY2lhY2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzY4ODYsImV4cCI6MjA4NTU1Mjg4Nn0.pAMtzCz5aM7vxGT_ZVK7TPzumdFXoroQfxaCUt8xmVI'
);

const firebaseConfig = {
  apiKey: "AIzaSyAGYjiyPqt7sNAFND9I22AIs7wGh6gB7pQ",
  projectId: "pahadfood",
  messagingSenderId: "93650163842",
  appId: "1:93650163842:android:afe5f5016e4410fa6ebc9b"
};

const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

window.state = { 
  tab: 'menu', 
  cart: {}, 
  cities: [], 
  chefs: [], 
  menu: [], 
  orders: [], 
  customer: JSON.parse(localStorage.getItem('customer') || '{}'),
  selectedCity: localStorage.getItem('selectedCity') || null,
  selectedCityName: localStorage.getItem('selectedCityName') || null,
  selectedChef: localStorage.getItem('selectedChef') || null,
  selectedChefName: localStorage.getItem('selectedChefName') || null,
  showMap: false,
  mapX: 0,
  mapY: 0,
  isDragging: false,
  dragStartX: 0,
  dragStartY: 0,
  deliveryType: 'delivery'
};

async function initFCM() {
  try {
    const token = await getToken(messaging, { vapidKey: 'BJCgA4WI7ZNbRXF86toihrZbLABf0XURwSMNXxMQZXnxDJLSkk61cWQ2lJbOFzvrrkWeH-H-DZakZzMQ30adlws' });
    if (token && state.customer.customer_id) {
      await supabase.from('customers').update({ fcm_token: token }).eq('customer_id', state.customer.customer_id);
    }
  } catch (e) { console.error('FCM error:', e); }
}

onMessage(messaging, (payload) => {
  showToast(payload.notification.title);
  if (state.tab === 'processing') loadOrders();
});

async function loadCities() {
  const { data } = await supabase.from('cities').select('*').eq('is_active', true);
  state.cities = data || [];
  render();
}

async function loadChefs(cityId) {
  showLoading(true);
  const { data } = await supabase.from('chefs').select('*').eq('city_id', cityId).eq('is_active', true);
  state.chefs = data || [];
  showLoading(false);
  render();
}

async function loadMenu(chefId) {
  showLoading(true);
  const { data } = await supabase.from('menu').select('*').eq('chef_id', chefId).eq('is_available', true);
  state.menu = data || [];
  showLoading(false);
  render();
}

async function loadOrders() {
  if (!state.customer.customer_id) return;
  const { data } = await supabase.from('orders')
    .select('*, order_items(*, menu(*))')
    .eq('customer_id', state.customer.customer_id)
    .in('current_status', ['placed', 'accepted', 'prepared', 'picked_up'])
    .order('created_at', { ascending: false });
  state.orders = data || [];
  render();
}

async function loadHistory() {
  if (!state.customer.customer_id) return;
  const now = new Date();
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
  const { data } = await supabase.from('orders')
    .select('*, order_items(*, menu(*))')
    .eq('customer_id', state.customer.customer_id)
    .gte('created_at', startOfMonth)
    .order('created_at', { ascending: false });
  state.history = data || [];
  render();
}

window.switchTab = (tab) => {
  state.tab = tab;
  document.querySelectorAll('.nav-item').forEach((el, i) => {
    el.classList.toggle('active', ['menu', 'processing', 'history'][i] === tab);
  });
  
  if (tab === 'processing') loadOrders();
  if (tab === 'history') loadHistory();
  
  render();
};

window.selectCity = (cityId, cityName) => {
  state.selectedCity = cityId;
  state.selectedCityName = cityName;
  state.selectedChef = null;
  state.selectedChefName = null;
  state.showMap = true;
  state.menu = [];
  state.cart = {};
  
  localStorage.setItem('selectedCity', cityId);
  localStorage.setItem('selectedCityName', cityName);
  localStorage.removeItem('selectedChef');
  localStorage.removeItem('selectedChefName');
  
  document.getElementById('headerLocation').textContent = cityName;
  loadChefs(cityId);
};

window.resetCity = () => {
  state.selectedCity = null;
  state.selectedCityName = null;
  state.selectedChef = null;
  state.selectedChefName = null;
  state.showMap = false;
  state.menu = [];
  state.cart = {};
  
  localStorage.removeItem('selectedCity');
  localStorage.removeItem('selectedCityName');
  localStorage.removeItem('selectedChef');
  localStorage.removeItem('selectedChefName');
  
  document.getElementById('headerLocation').textContent = 'Select City';
  render();
};

window.selectChef = (chefId, chefName) => {
  state.selectedChef = chefId;
  state.selectedChefName = chefName;
  state.showMap = false;
  state.cart = {};
  
  localStorage.setItem('selectedChef', chefId);
  localStorage.setItem('selectedChefName', chefName);
  
  loadMenu(chefId);
};

window.updateQty = (itemId, change) => {
  const current = state.cart[itemId] || 0;
  const newQty = current + change;
  if (newQty <= 0) {
    delete state.cart[itemId];
  } else {
    state.cart[itemId] = newQty;
  }
  render();
};

window.checkout = () => {
  const cartTotal = Object.entries(state.cart).reduce((sum, [id, qty]) => {
    const item = state.menu.find(m => m.item_id == id);
    return sum + (item?.price || 0) * qty;
  }, 0);
  
  if (cartTotal < 100) {
    showToast('Minimum order ₹100');
    return;
  }
  
  state.checkoutStep = 'details';
  render();
};

window.placeOrder = async () => {
  const name = document.getElementById('custName').value;
  const phone = document.getElementById('custPhone').value;
  const address = document.getElementById('custAddress').value;
  const specialInst = document.getElementById('specialInst').value;
  
  if (!name || !phone || !address) {
    showToast('Please fill all required fields');
    return;
  }
  
  showLoading(true);
  
  let customerId = state.customer.customer_id;
  if (!customerId) {
    const { data: existing } = await supabase.from('customers').select('*').eq('phone', phone).single();
    if (existing) {
      customerId = existing.customer_id;
    } else {
      const { data: newCustomer } = await supabase.from('customers').insert({ 
        name, phone, address, city_id: state.selectedCity 
      }).select().single();
      customerId = newCustomer.customer_id;
    }
    state.customer = { customer_id: customerId, name, phone, address, city_id: state.selectedCity };
    localStorage.setItem('customer', JSON.stringify(state.customer));
  } else {
    await supabase.from('customers').update({ name, phone, address }).eq('customer_id', customerId);
    state.customer = { ...state.customer, name, phone, address };
    localStorage.setItem('customer', JSON.stringify(state.customer));
  }
  
  const foodTotal = Object.entries(state.cart).reduce((sum, [id, qty]) => {
    const item = state.menu.find(m => m.item_id == id);
    return sum + (item?.price || 0) * qty;
  }, 0);
  
  const deliveryAmount = state.deliveryType === 'delivery' ? 50 : 0;
  const platformFee = state.deliveryType === 'delivery' ? 10 : 0;
  const totalAmount = foodTotal + deliveryAmount;
  
  const { data: order } = await supabase.from('orders').insert({
    customer_id: customerId,
    city_id: state.selectedCity,
    delivery_type: state.deliveryType,
    current_status: 'placed',
    delivery_amount: deliveryAmount,
    platform_fee: platformFee,
    total_amount: totalAmount
  }).select().single();
  
  for (const [itemId, qty] of Object.entries(state.cart)) {
    const item = state.menu.find(m => m.item_id == itemId);
    const itemTotal = item.price * qty;
    const chefAmount = itemTotal;
    
    await supabase.from('order_items').insert({
      order_id: order.order_id,
      item_id: itemId,
      chef_id: item.chef_id,
      quantity: qty,
      price_at_order_time: item.price,
      chef_amount: chefAmount
    });
  }
  
  await supabase.from('order_status_history').insert({
    order_id: order.order_id,
    status: 'placed',
    changed_by: 'customer'
  });
  
  state.cart = {};
  state.checkoutStep = null;
  showLoading(false);
  switchTab('processing');
  showToast('Order placed successfully! #' + order.order_id);
};

window.updateCustomer = async () => {
  const name = document.getElementById('histName').value;
  const phone = document.getElementById('histPhone').value;
  const address = document.getElementById('histAddress').value;
  
  if (!state.customer.customer_id) {
    showToast('Please place an order first');
    return;
  }
  
  await supabase.from('customers').update({ name, phone, address }).eq('customer_id', state.customer.customer_id);
  state.customer = { ...state.customer, name, phone, address };
  localStorage.setItem('customer', JSON.stringify(state.customer));
  showToast('Profile updated');
};

window.selectDeliveryType = (type) => {
  state.deliveryType = type;
  render();
};

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 3000);
}

function showLoading(show) {
  document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
}

function initMapDrag() {
  const mapWrapper = document.querySelector('.map-wrapper');
  if (!mapWrapper) return;
  
  let startX, startY, initialX, initialY;
  
  const handleStart = (e) => {
    state.isDragging = true;
    const touch = e.type.includes('touch') ? e.touches[0] : e;
    startX = touch.clientX;
    startY = touch.clientY;
    initialX = state.mapX;
    initialY = state.mapY;
    mapWrapper.style.transition = 'none';
  };
  
  const handleMove = (e) => {
    if (!state.isDragging) return;
    e.preventDefault();
    const touch = e.type.includes('touch') ? e.touches[0] : e;
    const deltaX = touch.clientX - startX;
    const deltaY = touch.clientY - startY;
    
    state.mapX = Math.max(Math.min(initialX + deltaX, 100), -500);
    state.mapY = Math.max(Math.min(initialY + deltaY, 100), -500);
    
    mapWrapper.style.transform = `translate(${state.mapX}px, ${state.mapY}px)`;
  };
  
  const handleEnd = () => {
    state.isDragging = false;
    mapWrapper.style.transition = 'transform 0.15s ease-out';
  };
  
  mapWrapper.addEventListener('touchstart', handleStart);
  mapWrapper.addEventListener('mousedown', handleStart);
  document.addEventListener('touchmove', handleMove, { passive: false });
  document.addEventListener('mousemove', handleMove);
  document.addEventListener('touchend', handleEnd);
  document.addEventListener('mouseup', handleEnd);
}

function render() {
  const app = document.getElementById('app');
  const cartBar = document.getElementById('cartBar');
  const cartTotal = document.getElementById('cartTotal');
  const cartSummary = document.getElementById('cartSummary');
  
  const cartAmount = Object.entries(state.cart).reduce((sum, [id, qty]) => {
    const item = state.menu.find(m => m.item_id == id);
    return sum + (item?.price || 0) * qty;
  }, 0);
  
  const cartItems = Object.values(state.cart).reduce((sum, qty) => sum + qty, 0);
  
  cartBar.classList.toggle('hidden', cartItems === 0 || state.tab !== 'menu' || state.checkoutStep === 'details');
  cartTotal.textContent = '₹' + cartAmount;
  cartSummary.textContent = `${cartItems} ${cartItems === 1 ? 'item' : 'items'} • ${state.selectedChefName || 'Chef'}`;
  
  document.getElementById('checkoutBtn').disabled = cartAmount < 100;
  
  if (state.checkoutStep === 'details') {
    const items = Object.entries(state.cart).map(([id, qty]) => {
      const item = state.menu.find(m => m.item_id == id);
      return `<div class="order-item"><span>${item.item_name} × ${qty}</span><span>₹${item.price * qty}</span></div>`;
    }).join('');
    
    const deliveryAmount = state.deliveryType === 'delivery' ? 50 : 0;
    const totalAmount = cartAmount + deliveryAmount;
    
    app.innerHTML = `<div class="checkout">
      <h2>Checkout</h2>
      
      <div class="order-summary">
        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Order Summary</h3>
        ${items}
        <div class="order-total">₹${cartAmount}</div>
      </div>
      
      <div class="form-section">
        <label class="form-label">Delivery Option</label>
        <div class="delivery-options">
          <div class="delivery-option ${state.deliveryType === 'delivery' ? 'selected' : ''}" onclick="selectDeliveryType('delivery')">
            <div class="delivery-option-icon">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="32" height="32">
                <path d="M9 17a2 2 0 1 1-4 0 2 2 0 0 1 4 0zM19 17a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"/>
                <path d="M13 16V6h-2v10M1 6h9v5H1zM20 6h-6v5h6z"/>
              </svg>
            </div>
            <h4>Delivery</h4>
            <p>+₹50</p>
          </div>
          <div class="delivery-option ${state.deliveryType === 'self_pickup' ? 'selected' : ''}" onclick="selectDeliveryType('self_pickup')">
            <div class="delivery-option-icon">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="32" height="32">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <path d="M9 22V12h6v10"/>
              </svg>
            </div>
            <h4>Pickup</h4>
            <p>Free</p>
          </div>
        </div>
      </div>
      
      <div class="form-section">
        <label class="form-label">Special Instructions</label>
        <textarea id="specialInst" class="form-textarea" placeholder="Any special requests for the chef? (Optional)"></textarea>
      </div>
      
      <div class="form-section">
        <label class="form-label">Name *</label>
        <input id="custName" class="form-input" value="${state.customer.name || ''}" placeholder="Your full name">
      </div>
      
      <div class="form-section">
        <label class="form-label">Phone Number *</label>
        <input id="custPhone" class="form-input" value="${state.customer.phone || ''}" placeholder="10 digit mobile number" type="tel">
      </div>
      
      <div class="form-section">
        <label class="form-label">Delivery Address *</label>
        <textarea id="custAddress" class="form-textarea" placeholder="House/Flat no, Street, Landmark">${state.customer.address || ''}</textarea>
      </div>
      
      <div class="price-breakdown">
        <div class="price-row">
          <span>Food Total</span>
          <span>₹${cartAmount}</span>
        </div>
        ${state.deliveryType === 'delivery' ? `<div class="price-row">
          <span>Delivery Fee</span>
          <span>₹50</span>
        </div>` : ''}
        <div class="price-row total">
          <span>Total Amount</span>
          <span>₹${totalAmount}</span>
        </div>
      </div>
      
      <button class="btn-primary" style="width: 100%;" onclick="placeOrder()">Place Order</button>
      <button class="btn-secondary" onclick="state.checkoutStep = null; render();">Back to Menu</button>
    </div>`;
    return;
  }
  
  if (state.tab === 'menu') {
    if (!state.selectedCity) {
      app.innerHTML = `<div class="city-selection">
        <h2>Where would you like to order from?</h2>
        <p>Select your city to explore nearby chefs</p>
      </div>
      <div class="city-grid">
        ${state.cities.map(city => `
          <div class="city-card" onclick="selectCity(${city.city_id}, '${city.city_name}')">
            <div class="city-card-icon">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="24" height="24">
                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                <circle cx="12" cy="9" r="2.5"/>
              </svg>
            </div>
            <h3>${city.city_name}</h3>
            <p>Explore chefs</p>
          </div>
        `).join('')}
      </div>`;
      return;
    }
    
    if (state.showMap && state.chefs.length > 0) {
      const chefPositions = state.chefs.map((_, i) => {
        const angle = (i / state.chefs.length) * Math.PI * 2;
        const radius = 150 + Math.random() * 100;
        return {
          x: 400 + Math.cos(angle) * radius,
          y: 400 + Math.sin(angle) * radius
        };
      });
      
      app.innerHTML = `<div class="map-container">
        <div class="map-instructions">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M7 10l5 5 5-5"/>
          </svg>
          Drag to explore • Tap shop to view menu
        </div>
        <div class="map-wrapper" style="transform: translate(${state.mapX}px, ${state.mapY}px)">
          <div class="map-grid"></div>
          <div class="map-roads">
            <div class="road horizontal" style="top: 30%;"></div>
            <div class="road horizontal" style="top: 60%;"></div>
            <div class="road vertical" style="left: 35%;"></div>
            <div class="road vertical" style="left: 65%;"></div>
          </div>
          ${state.chefs.map((chef, i) => `
            <div class="map-chef" style="left: ${chefPositions[i].x}px; top: ${chefPositions[i].y}px;" onclick="selectChef(${chef.chef_id}, '${chef.name}')">
              <div class="chef-marker">
                <div class="chef-building">
                  <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <path d="M9 22V12h6v10"/>
                  </svg>
                </div>
                <div class="chef-name">${chef.name}</div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>`;
      
      setTimeout(initMapDrag, 0);
      return;
    }
    
    if (state.menu.length === 0 && state.selectedChef) {
      app.innerHTML = `<div class="empty-state">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 8v4M12 16h.01"/>
        </svg>
        <h3>No items available</h3>
        <p>This chef hasn't added any items yet</p>
      </div>`;
      return;
    }
    
    if (state.menu.length > 0) {
      app.innerHTML = `
        <div class="menu-header">
          <h2>${state.selectedChefName}</h2>
          <p>${state.selectedCityName}</p>
        </div>
        <div class="menu-grid">
          ${state.menu.map(item => {
            const qty = state.cart[item.item_id] || 0;
            return `<div class="menu-card">
              <img src="${item.image_url}" alt="${item.item_name}" class="menu-card-img">
              ${qty > 0 ? `<div class="item-badge">${qty}</div>` : ''}
              <div class="menu-card-content">
                <div class="menu-card-title">${item.item_name}</div>
                <div class="menu-card-price">₹${item.price}</div>
                <div class="menu-card-controls">
                  ${qty > 0 ? `
                    <button class="qty-btn minus" onclick="updateQty(${item.item_id}, -1)">−</button>
                    <div class="qty-display">${qty}</div>
                  ` : ''}
                  <button class="qty-btn" onclick="updateQty(${item.item_id}, 1)" style="${qty > 0 ? '' : 'width: 100%;'}">+</button>
                </div>
              </div>
            </div>`;
          }).join('')}
        </div>
      `;
      return;
    }
  }
  
  if (state.tab === 'processing') {
    const statusMap = {
      placed: 'Order Placed',
      accepted: 'Preparing',
      prepared: 'Ready',
      picked_up: 'On the Way',
      delivered: 'Delivered'
    };
    
    app.innerHTML = `<div class="orders-container">
      <h2 style="font-family: 'DM Serif Display', serif; font-size: 24px; margin-bottom: 16px;">Active Orders</h2>
      ${state.orders.length === 0 ? `
        <div class="empty-state">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <h3>No active orders</h3>
          <p>Your orders will appear here</p>
        </div>
      ` : state.orders.map(order => `
        <div class="order-card">
          <div class="order-header">
            <div class="order-id">Order #${order.order_id}</div>
            <div class="order-status">${statusMap[order.current_status]}</div>
          </div>
          <div class="order-items">
            ${order.order_items.map(i => 
              `<div class="order-item-row">${i.menu.item_name} × ${i.quantity}</div>`
            ).join('')}
          </div>
          <div class="order-total-row">₹${order.total_amount}</div>
        </div>
      `).join('')}
    </div>`;
  }
  
  if (state.tab === 'history') {
    app.innerHTML = `<div class="orders-container">
      <h2 style="font-family: 'DM Serif Display', serif; font-size: 24px; margin-bottom: 16px;">Profile</h2>
      
      <div class="form-section">
        <label class="form-label">Name</label>
        <input id="histName" class="form-input" value="${state.customer.name || ''}" placeholder="Your name">
      </div>
      
      <div class="form-section">
        <label class="form-label">Phone</label>
        <input id="histPhone" class="form-input" value="${state.customer.phone || ''}" placeholder="10 digit mobile">
      </div>
      
      <div class="form-section">
        <label class="form-label">Address</label>
        <textarea id="histAddress" class="form-textarea">${state.customer.address || ''}</textarea>
      </div>
      
      <button class="btn-primary" style="width: 100%;" onclick="updateCustomer()">Update Profile</button>
      
      <h3 style="font-family: 'DM Serif Display', serif; font-size: 20px; margin: 32px 0 16px;">Order History</h3>
      
      ${(state.history || []).length === 0 ? `
        <div class="empty-state">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M9 11h6M9 15h3"/>
          </svg>
          <h3>No orders yet</h3>
          <p>Your order history will appear here</p>
        </div>
      ` : (state.history || []).map(order => `
        <div class="order-card">
          <div class="order-header">
            <div class="order-id">Order #${order.order_id}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">${new Date(order.created_at).toLocaleDateString()}</div>
          </div>
          <div class="order-items">
            ${order.order_items.map(i => 
              `<div class="order-item-row">${i.menu.item_name} × ${i.quantity}</div>`
            ).join('')}
          </div>
          <div class="order-total-row">₹${order.total_amount}</div>
        </div>
      `).join('')}
    </div>`;
  }
}

window.supabase = supabase;

loadCities();
initFCM();

if (state.selectedCity) {
  loadChefs(state.selectedCity).then(() => {
    if (state.selectedChef) {
      loadMenu(state.selectedChef);
    }
  });
}

render();
</script>

</body>
</html>