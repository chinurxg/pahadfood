<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pahad Food</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #1a1a1a;
  --secondary: #666;
  --border: #e0e0e0;
  --bg: #fff;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--primary); }
.header { 
  background: linear-gradient(to right, rgba(255,255,255,0.95), transparent), url('https://images.unsplash.com/photo-1538947151057-dfe933d688d1?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D') center/cover; 
  height: 20vh; display: flex; align-items: center; justify-content: center; 
}
.header h1 { font-family: 'Playfair Display', serif; font-size: 2.5rem; letter-spacing: 2px; }
.container { padding: 16px; max-width: 600px; margin: 0 auto; padding-bottom: 140px; }
select, input, textarea { 
  width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); 
  border-radius: 6px; font-size: 15px; font-family: inherit; 
}
.menu-item { 
  display: flex; gap: 12px; padding: 12px; border: 1px solid var(--border); 
  border-radius: 8px; margin: 8px 0; align-items: center; background: white;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.menu-item .left { flex: 1; }
.menu-item h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
.menu-item .price { color: var(--secondary); font-size: 14px; margin-bottom: 8px; }
.menu-item .controls { display: flex; gap: 8px; align-items: center; }
.menu-item .controls button { 
  width: 32px; height: 32px; border: 1px solid var(--border); background: var(--bg); 
  border-radius: 50%; cursor: pointer; font-size: 18px; 
}
.menu-item .controls button:disabled { opacity: 0.3; cursor: not-allowed; }
.menu-item .img-wrap { position: relative; width: 80px; height: 80px; flex-shrink: 0; }
.menu-item img { 
  width: 100%; height: 100%; object-fit: cover; border-radius: 6px; 
  -webkit-mask-image: linear-gradient(to right, transparent, black 30%);
  mask-image: linear-gradient(to right, transparent, black 30%);
}
.menu-item .badge { 
  position: absolute; top: -4px; right: -4px; background: var(--primary); color: white; 
  border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; 
  justify-content: center; font-size: 12px; font-weight: 600; 
}
.proceed-bar { 
  position: fixed; bottom: 60px; left: 0; right: 0; background: var(--bg); 
  border-top: 1px solid var(--border); padding: 12px 16px; z-index: 100; 
  box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
}
.proceed-bar .selection-info {
  font-size: 13px;
  color: var(--secondary);
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}
.proceed-bar .price-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.proceed-bar button { 
  padding: 12px 32px; background: var(--primary); color: white; border: none; 
  border-radius: 6px; font-weight: 600; cursor: pointer; 
}
.proceed-bar button:disabled { opacity: 0.5; cursor: not-allowed; }
.bottom-nav { 
  position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg); 
  border-top: 1px solid var(--border); display: flex; z-index: 101; 
}
.bottom-nav div { 
  flex: 1; padding: 12px; text-align: center; cursor: pointer; 
  font-size: 14px; font-weight: 500; 
}
.bottom-nav div.active { color: var(--primary); border-top: 2px solid var(--primary); }
.bottom-nav div:not(.active) { color: var(--secondary); }
.order-card { 
  border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin: 8px 0; 
  background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.order-card h4 { font-size: 14px; margin-bottom: 8px; font-weight: 600; }
.order-card .status { 
  display: inline-block; padding: 4px 12px; background: #f5f5f5; 
  border-radius: 20px; font-size: 12px; margin-top: 8px; 
}
.checkout { padding-bottom: 80px; }
.checkout h2 { font-size: 20px; margin: 16px 0; }
.checkout .item-list { margin: 12px 0; }
.checkout .item-list div { display: flex; justify-content: space-between; padding: 8px 0; }
.checkout .total { 
  font-weight: 600; padding-top: 12px; border-top: 1px solid var(--border); 
  margin-top: 12px; font-size: 18px; 
}
.toast { 
  position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
  background: var(--primary); color: white; padding: 12px 24px; border-radius: 6px; 
  z-index: 1000; display: none; 
}
.hidden { display: none !important; }
label { display: block; font-size: 14px; margin: 12px 0 4px; font-weight: 500; }

/* Shimmer loading effect */
.shimmer-wrapper { padding: 16px; }
.shimmer { 
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 8px;
  margin: 8px 0;
}
@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
.shimmer-item {
  height: 96px;
  margin: 12px 0;
}
.shimmer-select {
  height: 48px;
  margin: 8px 0;
}
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--secondary);
}
.empty-state svg {
  width: 64px;
  height: 64px;
  margin-bottom: 16px;
  opacity: 0.3;
}
</style>
</head>
<body>

<div class="header"><h1>PAHAD FOOD</h1></div>

<div id="app"></div>

<div id="proceedBar" class="proceed-bar hidden">
  <div class="selection-info" id="selectionInfo"></div>
  <div class="price-row">
    <span id="totalPrice">₹0</span>
    <button onclick="checkout()" id="proceedBtn">Proceed</button>
  </div>
</div>

<div class="bottom-nav">
  <div class="active" onclick="switchTab('menu')">Menu</div>
  <div onclick="switchTab('processing')">Processing</div>
  <div onclick="switchTab('history')">History</div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';

const supabase = window.supabase.createClient(
  'https://zjuugofcrnieigciaclb.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqdXVnb2Zjcm5pZWlnY2lhY2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzY4ODYsImV4cCI6MjA4NTU1Mjg4Nn0.pAMtzCz5aM7vxGT_ZVK7TPzumdFXoroQfxaCUt8xmVI'
);

const firebaseConfig = {
  apiKey: "AIzaSyAGYjiyPqt7sNAFND9I22AIs7wGh6gB7pQ",
  projectId: "pahadfood",
  messagingSenderId: "93650163842",
  appId: "1:93650163842:android:afe5f5016e4410fa6ebc9b"
};

const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

window.state = { 
  tab: 'menu', 
  cart: {}, 
  cities: [], 
  chefs: [], 
  menu: [], 
  orders: [], 
  customer: JSON.parse(localStorage.getItem('customer') || '{}'),
  selectedCity: localStorage.getItem('selectedCity') || null,
  selectedCityName: localStorage.getItem('selectedCityName') || null,
  selectedChef: localStorage.getItem('selectedChef') || null,
  selectedChefName: localStorage.getItem('selectedChefName') || null,
  loading: true,
  processingInterval: null
};

async function initFCM() {
  try {
    const token = await getToken(messaging, { vapidKey: 'BJCgA4WI7ZNbRXF86toihrZbLABf0XURwSMNXxMQZXnxDJLSkk61cWQ2lJbOFzvrrkWeH-H-DZakZzMQ30adlws' });
    if (token && state.customer.customer_id) {
      await supabase.from('customers').update({ fcm_token: token }).eq('customer_id', state.customer.customer_id);
    }
  } catch (e) { console.error('FCM error:', e); }
}

onMessage(messaging, (payload) => {
  showToast(payload.notification.title);
  if (state.tab === 'processing') loadOrders();
});

async function loadCities() {
  state.loading = true;
  render();
  const { data } = await supabase.from('cities').select('*').eq('is_active', true);
  state.cities = data || [];
  state.loading = false;
  render();
}

async function loadChefs(cityId) {
  state.loading = true;
  render();
  const { data } = await supabase.from('chefs').select('*').eq('city_id', cityId).eq('is_active', true);
  state.chefs = data || [];
  state.loading = false;
  render();
}

async function loadMenu(chefId) {
  state.loading = true;
  render();
  const { data } = await supabase.from('menu').select('*').eq('chef_id', chefId).eq('is_available', true);
  state.menu = data || [];
  state.loading = false;
  render();
}

async function loadOrders() {
  if (!state.customer.customer_id) return;
  const { data } = await supabase.from('orders')
    .select('*, order_items(*, menu(*))')
    .eq('customer_id', state.customer.customer_id)
    .in('current_status', ['placed', 'accepted', 'prepared', 'picked_up'])
    .order('created_at', { ascending: false });
  state.orders = data || [];
  render();
}

async function loadHistory() {
  if (!state.customer.customer_id) return;
  const now = new Date();
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
  const { data } = await supabase.from('orders')
    .select('*, order_items(*, menu(*))')
    .eq('customer_id', state.customer.customer_id)
    .gte('created_at', startOfMonth)
    .order('created_at', { ascending: false });
  state.history = data || [];
  render();
}

window.switchTab = (tab) => {
  // Clear any existing interval
  if (state.processingInterval) {
    clearInterval(state.processingInterval);
    state.processingInterval = null;
  }
  
  state.tab = tab;
  document.querySelectorAll('.bottom-nav div').forEach((el, i) => {
    el.classList.toggle('active', ['menu', 'processing', 'history'][i] === tab);
  });
  
  if (tab === 'processing') {
    loadOrders();
    // Auto-refresh every 5 seconds
    state.processingInterval = setInterval(loadOrders, 5000);
  }
  if (tab === 'history') loadHistory();
  
  render();
};

window.updateQty = (itemId, change) => {
  const current = state.cart[itemId] || 0;
  const newQty = current + change;
  if (newQty <= 0) {
    delete state.cart[itemId];
  } else {
    state.cart[itemId] = newQty;
  }
  render();
};

window.checkout = () => {
  const cartTotal = Object.entries(state.cart).reduce((sum, [id, qty]) => {
    const item = state.menu.find(m => m.item_id == id);
    return sum + (item?.price || 0) * qty;
  }, 0);
  
  if (cartTotal < 100) {
    showToast('Add items worth at least ₹100 to continue');
    return;
  }
  
  state.checkoutStep = 'details';
  render();
};

window.placeOrder = async () => {
  const name = document.getElementById('custName').value;
  const phone = document.getElementById('custPhone').value;
  const address = document.getElementById('custAddress').value;
  const city = document.getElementById('custCity').value;
  const deliveryType = document.getElementById('deliveryType').value;
  const specialInst = document.getElementById('specialInst').value;
  const deliveryInst = document.getElementById('deliveryInst').value;
  
  if (!name || !phone || !address) {
    showToast('Please fill all required fields');
    return;
  }
  
  // Get or create customer
  let customerId = state.customer.customer_id;
  if (!customerId) {
    const { data: existing } = await supabase.from('customers').select('*').eq('phone', phone).single();
    if (existing) {
      customerId = existing.customer_id;
    } else {
      const { data: newCustomer } = await supabase.from('customers').insert({ 
        name, phone, address, city_id: city 
      }).select().single();
      customerId = newCustomer.customer_id;
    }
    state.customer = { customer_id: customerId, name, phone, address, city_id: city };
    localStorage.setItem('customer', JSON.stringify(state.customer));
  } else {
    await supabase.from('customers').update({ name, phone, address }).eq('customer_id', customerId);
    state.customer = { ...state.customer, name, phone, address };
    localStorage.setItem('customer', JSON.stringify(state.customer));
  }
  
  // Calculate food total
  const foodTotal = Object.entries(state.cart).reduce((sum, [id, qty]) => {
    const item = state.menu.find(m => m.item_id == id);
    return sum + (item?.price || 0) * qty;
  }, 0);
  
  // Calculate charges - FIXED VERSION
  const deliveryAmount = deliveryType === 'delivery' ? 50 : 0;
  const platformFee = deliveryType === 'delivery' ? 10 : 0; // Platform gets ₹10 from ₹50 delivery fee
  const totalAmount = foodTotal + deliveryAmount;
  
  // Create order
  const { data: order } = await supabase.from('orders').insert({
    customer_id: customerId,
    city_id: city,
    delivery_type: deliveryType,
    current_status: 'placed',
    delivery_amount: deliveryAmount,
    platform_fee: platformFee,
    total_amount: totalAmount
  }).select().single();
  
  // Insert order items - FIXED: Chef gets 100% of food amount
  for (const [itemId, qty] of Object.entries(state.cart)) {
    const item = state.menu.find(m => m.item_id == itemId);
    const itemTotal = item.price * qty;
    
    // CRITICAL FIX: Chef gets 100% of food price, no deductions!
    const chefAmount = itemTotal;
    
    await supabase.from('order_items').insert({
      order_id: order.order_id,
      item_id: itemId,
      chef_id: item.chef_id,
      quantity: qty,
      price_at_order_time: item.price,
      chef_amount: chefAmount // Chef gets full food amount
    });
  }
  
  await supabase.from('order_status_history').insert({
    order_id: order.order_id,
    status: 'placed',
    changed_by: 'customer'
  });
  
  state.cart = {};
  state.checkoutStep = null;
  switchTab('processing');
  showToast('Order placed! Order #' + order.order_id);
};

window.updateCustomer = async () => {
  const name = document.getElementById('histName').value;
  const phone = document.getElementById('histPhone').value;
  const address = document.getElementById('histAddress').value;
  
  if (!state.customer.customer_id) {
    showToast('Please place an order first');
    return;
  }
  
  await supabase.from('customers').update({ name, phone, address }).eq('customer_id', state.customer.customer_id);
  state.customer = { ...state.customer, name, phone, address };
  localStorage.setItem('customer', JSON.stringify(state.customer));
  showToast('Details updated');
};

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 3000);
}

function render() {
  const app = document.getElementById('app');
  const proceedBar = document.getElementById('proceedBar');
  const totalPrice = document.getElementById('totalPrice');
  const selectionInfo = document.getElementById('selectionInfo');
  
  const cartTotal = Object.entries(state.cart).reduce((sum, [id, qty]) => {
    const item = state.menu.find(m => m.item_id == id);
    return sum + (item?.price || 0) * qty;
  }, 0);
  
  const hasItems = Object.keys(state.cart).length > 0;
  
  // Show proceed bar when in menu tab with items OR when city/chef is selected
  const showProceedBar = (state.tab === 'menu' && !state.checkoutStep) && (hasItems || state.selectedCityName);
  proceedBar.classList.toggle('hidden', !showProceedBar);
  
  // Update selection info
  if (state.selectedCityName && state.selectedChefName) {
    selectionInfo.textContent = `${state.selectedCityName} • ${state.selectedChefName}`;
  } else if (state.selectedCityName) {
    selectionInfo.textContent = state.selectedCityName;
  } else {
    selectionInfo.textContent = '';
  }
  
  totalPrice.textContent = '₹' + cartTotal;
  const proceedBtn = document.getElementById('proceedBtn');
  proceedBtn.disabled = cartTotal < 100;
  proceedBtn.style.display = hasItems ? 'block' : 'none';
  
  if (state.checkoutStep === 'details') {
    const items = Object.entries(state.cart).map(([id, qty]) => {
      const item = state.menu.find(m => m.item_id == id);
      return `<div><span>${item.item_name} x${qty}</span><span>₹${item.price * qty}</span></div>`;
    }).join('');
    
    app.innerHTML = `<div class="container checkout">
      <h2>Order Summary</h2>
      <div class="item-list">${items}</div>
      <div class="total">Subtotal: ₹${cartTotal}</div>
      
      <label>Special Instructions for Chef</label>
      <textarea id="specialInst" rows="2" placeholder="Optional"></textarea>
      
      <label>Name *</label>
      <input id="custName" value="${state.customer.name || ''}" placeholder="Your name" required>
      
      <label>Phone *</label>
      <input id="custPhone" value="${state.customer.phone || ''}" placeholder="10 digit mobile number" required>
      
      <label>Address in ${state.selectedCityName || 'selected area'} *</label>
      <textarea id="custAddress" rows="2" required placeholder="House no, street, landmark">${state.customer.address || ''}</textarea>
      
      <input type="hidden" id="custCity" value="${state.selectedCity}">
      
      <label>Delivery Instructions</label>
      <input id="deliveryInst" placeholder="Optional delivery notes">
      
      <label>Delivery Option</label>
      <select id="deliveryType" onchange="updateDeliveryTotal()">
        <option value="delivery">Home Delivery (+₹50)</option>
        <option value="self_pickup">Pickup from Chef (Free)</option>
      </select>
      
      <div style="margin-top: 16px; padding: 12px; background: #f9f9f9; border-radius: 6px;">
        <div style="display: flex; justify-content: space-between; margin: 4px 0;">
          <span>Food Total</span><span>₹${cartTotal}</span>
        </div>
        <div id="deliveryFeeRow" style="display: flex; justify-content: space-between; margin: 4px 0;">
          <span>Delivery Charges</span><span>₹50</span>
        </div>
        <div class="total" id="finalTotal">Total: ₹${cartTotal + 50}</div>
      </div>
      
      <button onclick="placeOrder()" style="width: 100%; margin-top: 16px; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">Place Order</button>
      <button onclick="state.checkoutStep = null; render();" style="width: 100%; margin-top: 8px; padding: 14px; background: white; color: var(--primary); border: 1px solid var(--border); border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">Back</button>
    </div>`;
    return;
  }
  
  if (state.tab === 'menu') {
    let html = '<div class="container">';
    
    // City selection
    if (state.loading && state.cities.length === 0) {
      html += '<div class="shimmer shimmer-select"></div>';
    } else {
      html += `<select onchange="handleCityChange(this)" id="citySelect">
        <option value="">Select City/Town/Area</option>`;
      state.cities.forEach(c => {
        html += `<option value="${c.city_id}" ${state.selectedCity == c.city_id ? 'selected' : ''}>${c.city_name}</option>`;
      });
      html += '</select>';
    }
    
    // Chef selection
    if (state.selectedCity) {
      if (state.loading && state.chefs.length === 0) {
        html += '<div class="shimmer shimmer-select"></div>';
      } else {
        html += `<select onchange="handleChefChange(this)" id="chefSelect">
          <option value="">Select Chef</option>`;
        state.chefs.forEach(c => {
          html += `<option value="${c.chef_id}" ${state.selectedChef == c.chef_id ? 'selected' : ''}>${c.name}</option>`;
        });
        html += '</select>';
      }
    }
    
    // Menu items
    if (state.loading && state.menu.length === 0 && state.selectedChef) {
      for (let i = 0; i < 3; i++) {
        html += '<div class="shimmer shimmer-item"></div>';
      }
    } else if (state.menu.length === 0 && state.selectedChef) {
      html += `<div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 3h18v18H3z"/><path d="M9 9h6v6H9z"/>
        </svg>
        <p>No items available</p>
      </div>`;
    } else {
      state.menu.forEach(item => {
        const qty = state.cart[item.item_id] || 0;
        html += `<div class="menu-item">
          <div class="left">
            <h3>${item.item_name}</h3>
            <div class="price">₹${item.price}</div>
            <div class="controls">
              <button onclick="updateQty(${item.item_id}, -1)" ${qty === 0 ? 'disabled' : ''}>−</button>
              <button onclick="updateQty(${item.item_id}, 1)">+</button>
            </div>
          </div>
          <div class="img-wrap">
            <img src="${item.image_url}" alt="${item.item_name}">
            ${qty > 0 ? `<div class="badge">${qty}</div>` : ''}
          </div>
        </div>`;
      });
    }
    
    html += '</div>';
    app.innerHTML = html;
  }
  
  if (state.tab === 'processing') {
    let html = '<div class="container">';
    if (state.orders.length === 0) {
      html += `<div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
        </svg>
        <p>No active orders</p>
      </div>`;
    } else {
      state.orders.forEach(order => {
        const statusMap = {
          placed: 'Waiting for chef approval',
          accepted: 'Accepted by chef',
          prepared: 'Being prepared',
          picked_up: 'Out for delivery',
          delivered: 'Delivered'
        };
        html += `<div class="order-card">
          <h4>Order #${order.order_id}</h4>
          ${order.order_items.map(i => `<div style="font-size: 13px;">${i.menu.item_name} x${i.quantity}</div>`).join('')}
          <div style="font-weight: 600; margin-top: 8px;">₹${order.total_amount}</div>
          <div class="status">${statusMap[order.current_status]}</div>
        </div>`;
      });
    }
    html += '</div>';
    app.innerHTML = html;
  }
  
  if (state.tab === 'history') {
    let html = '<div class="container">';
    html += `<h3 style="margin: 16px 0;">Your Details</h3>
      <label>Name</label>
      <input id="histName" value="${state.customer.name || ''}" placeholder="Your name">
      <label>Phone</label>
      <input id="histPhone" value="${state.customer.phone || ''}" placeholder="10 digit mobile">
      <label>Address</label>
      <textarea id="histAddress" rows="2" placeholder="Your address">${state.customer.address || ''}</textarea>
      <button onclick="updateCustomer()" style="margin-top: 8px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">Update</button>
      
      <h3 style="margin: 24px 0 16px;">This Month's Orders</h3>`;
    
    if ((state.history || []).length === 0) {
      html += `<div class="empty-state" style="padding: 20px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 48px; height: 48px;">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M9 11h6M9 15h3"/>
        </svg>
        <p>No orders this month</p>
      </div>`;
    } else {
      (state.history || []).forEach(order => {
        html += `<div class="order-card">
          <h4>Order #${order.order_id}</h4>
          <div style="font-size: 12px; color: var(--secondary);">${new Date(order.created_at).toLocaleDateString()}</div>
          ${order.order_items.map(i => `<div style="font-size: 13px;">${i.menu.item_name} x${i.quantity}</div>`).join('')}
          <div style="font-weight: 600; margin-top: 8px;">₹${order.total_amount}</div>
        </div>`;
      });
    }
    html += '</div>';
    app.innerHTML = html;
  }
}

window.handleCityChange = function(select) {
  const cityId = select.value;
  state.selectedCity = cityId;
  state.selectedChef = null;
  state.selectedChefName = null;
  state.menu = [];
  state.cart = {};
  
  const cityName = state.cities.find(c => c.city_id == cityId)?.city_name || '';
  state.selectedCityName = cityName;
  
  localStorage.setItem('selectedCity', cityId);
  localStorage.setItem('selectedCityName', cityName);
  localStorage.removeItem('selectedChef');
  localStorage.removeItem('selectedChefName');
  
  if (cityId) {
    loadChefs(cityId);
  } else {
    state.chefs = [];
    render();
  }
};

window.handleChefChange = function(select) {
  const chefId = select.value;
  state.selectedChef = chefId;
  state.cart = {};
  
  const chefName = state.chefs.find(c => c.chef_id == chefId)?.name || '';
  state.selectedChefName = chefName;
  
  localStorage.setItem('selectedChef', chefId);
  localStorage.setItem('selectedChefName', chefName);
  
  if (chefId) {
    loadMenu(chefId);
  } else {
    state.menu = [];
    render();
  }
};

window.updateDeliveryTotal = function() {
  const deliveryType = document.getElementById('deliveryType').value;
  const deliveryFeeRow = document.getElementById('deliveryFeeRow');
  const finalTotal = document.getElementById('finalTotal');
  
  const cartTotal = Object.entries(state.cart).reduce((sum, [id, qty]) => {
    const item = state.menu.find(m => m.item_id == id);
    return sum + (item?.price || 0) * qty;
  }, 0);
  
  if (deliveryType === 'self_pickup') {
    deliveryFeeRow.style.display = 'none';
    finalTotal.textContent = 'Total: ₹' + cartTotal;
  } else {
    deliveryFeeRow.style.display = 'flex';
    finalTotal.textContent = 'Total: ₹' + (cartTotal + 50);
  }
};

window.supabase = supabase;
window.loadChefs = loadChefs;
window.loadMenu = loadMenu;
window.loadOrders = loadOrders;

// Initialize
loadCities();
initFCM();

// Load remembered selections
if (state.selectedCity) {
  loadChefs(state.selectedCity).then(() => {
    if (state.selectedChef) {
      loadMenu(state.selectedChef);
    }
  });
}

render();
</script>

</body>
</html>