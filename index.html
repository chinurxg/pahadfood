<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pahad Food</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #1a1a1a;
  --secondary: #666;
  --border: #e0e0e0;
  --bg: #fff;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--primary); }
.header { 
  background: linear-gradient(to right, rgba(255,255,255,0.95), transparent), url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800') center/cover; 
  height: 20vh; display: flex; align-items: center; justify-content: center; 
}
.header h1 { font-family: 'Playfair Display', serif; font-size: 2.5rem; letter-spacing: 2px; }
.container { padding: 16px; max-width: 600px; margin: 0 auto; }
select, input, textarea { 
  width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); 
  border-radius: 4px; font-size: 15px; font-family: inherit; 
}
.menu-item { 
  display: flex; gap: 12px; padding: 12px; border: 1px solid var(--border); 
  border-radius: 8px; margin: 8px 0; align-items: center; 
}
.menu-item .left { flex: 1; }
.menu-item h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
.menu-item .price { color: var(--secondary); font-size: 14px; margin-bottom: 8px; }
.menu-item .controls { display: flex; gap: 8px; align-items: center; }
.menu-item .controls button { 
  width: 32px; height: 32px; border: 1px solid var(--border); background: var(--bg); 
  border-radius: 50%; cursor: pointer; font-size: 18px; 
}
.menu-item .controls button:disabled { opacity: 0.3; cursor: not-allowed; }
.menu-item .img-wrap { position: relative; width: 80px; height: 80px; flex-shrink: 0; }
.menu-item img { 
  width: 100%; height: 100%; object-fit: cover; border-radius: 6px; 
  -webkit-mask-image: linear-gradient(to right, transparent, black 30%);
  mask-image: linear-gradient(to right, transparent, black 30%);
}
.menu-item .badge { 
  position: absolute; top: -4px; right: -4px; background: var(--primary); color: white; 
  border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; 
  justify-content: center; font-size: 12px; font-weight: 600; 
}
.proceed-bar { 
  position: fixed; bottom: 60px; left: 0; right: 0; background: var(--bg); 
  border-top: 1px solid var(--border); padding: 12px 16px; display: flex; 
  justify-content: space-between; align-items: center; z-index: 100; 
}
.proceed-bar button { 
  padding: 12px 32px; background: var(--primary); color: white; border: none; 
  border-radius: 6px; font-weight: 600; cursor: pointer; 
}
.proceed-bar button:disabled { opacity: 0.5; cursor: not-allowed; }
.bottom-nav { 
  position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg); 
  border-top: 1px solid var(--border); display: flex; z-index: 101; 
}
.bottom-nav div { 
  flex: 1; padding: 12px; text-align: center; cursor: pointer; 
  font-size: 14px; font-weight: 500; 
}
.bottom-nav div.active { color: var(--primary); border-top: 2px solid var(--primary); }
.bottom-nav div:not(.active) { color: var(--secondary); }
.order-card { 
  border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin: 8px 0; 
}
.order-card h4 { font-size: 14px; margin-bottom: 8px; }
.order-card .status { 
  display: inline-block; padding: 4px 12px; background: #f5f5f5; 
  border-radius: 20px; font-size: 12px; margin-top: 8px; 
}
.checkout { padding-bottom: 80px; }
.checkout h2 { font-size: 20px; margin: 16px 0; }
.checkout .item-list { margin: 12px 0; }
.checkout .item-list div { display: flex; justify-content: space-between; padding: 8px 0; }
.checkout .total { 
  font-weight: 600; padding-top: 12px; border-top: 1px solid var(--border); 
  margin-top: 12px; font-size: 18px; 
}
.toast { 
  position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
  background: var(--primary); color: white; padding: 12px 24px; border-radius: 6px; 
  z-index: 1000; display: none; 
}
.hidden { display: none !important; }
label { display: block; font-size: 14px; margin: 12px 0 4px; font-weight: 500; }
</style>
</head>
<body>

<div class="header"><h1>PAHAD FOOD</h1></div>

<div id="app"></div>

<div id="proceedBar" class="proceed-bar hidden">
  <span id="totalPrice">₹0</span>
  <button onclick="checkout()">Proceed</button>
</div>

<div class="bottom-nav">
  <div class="active" onclick="switchTab('menu')">Menu</div>
  <div onclick="switchTab('processing')">Processing</div>
  <div onclick="switchTab('history')">History</div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';

const supabase = window.supabase.createClient(
  'https://zjuugofcrnieigciaclb.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqdXVnb2Zjcm5pZWlnY2lhY2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzY4ODYsImV4cCI6MjA4NTU1Mjg4Nn0.pAMtzCz5aM7vxGT_ZVK7TPzumdFXoroQfxaCUt8xmVI'
);

const firebaseConfig = {
  apiKey: "AIzaSyAGYjiyPqt7sNAFND9I22AIs7wGh6gB7pQ",
  projectId: "pahadfood",
  messagingSenderId: "93650163842",
  appId: "1:93650163842:android:afe5f5016e4410fa6ebc9b"
};

const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

window.state = { tab: 'menu', cart: {}, cities: [], chefs: [], menu: [], orders: [], customer: JSON.parse(localStorage.getItem('customer') || '{}') };

async function initFCM() {
  try {
    const token = await getToken(messaging, { vapidKey: 'BJCgA4WI7ZNbRXF86toihrZbLABf0XURwSMNXxMQZXnxDJLSkk61cWQ2lJbOFzvrrkWeH-H-DZakZzMQ30adlws' });
    if (token && state.customer.customer_id) {
      await supabase.from('customers').update({ fcm_token: token }).eq('customer_id', state.customer.customer_id);
    }
  } catch (e) { console.error('FCM error:', e); }
}

onMessage(messaging, (payload) => {
  showToast(payload.notification.title);
  if (state.tab === 'processing') loadOrders();
});

async function loadCities() {
  const { data } = await supabase.from('cities').select('*').eq('is_active', true);
  state.cities = data || [];
  render();
}

async function loadChefs(cityId) {
  const { data } = await supabase.from('chefs').select('*').eq('city_id', cityId).eq('is_active', true);
  state.chefs = data || [];
  state.selectedChef = null;
  render();
}

async function loadMenu(chefId) {
  const { data } = await supabase.from('menu').select('*').eq('chef_id', chefId).eq('is_available', true);
  state.menu = data || [];
  state.selectedChef = chefId;
  render();
}

async function loadOrders() {
  if (!state.customer.customer_id) return;
  const { data } = await supabase.from('orders')
    .select('*, order_items(*, menu(*))')
    .eq('customer_id', state.customer.customer_id)
    .in('current_status', ['placed', 'accepted', 'prepared', 'picked_up'])
    .order('created_at', { ascending: false });
  state.orders = data || [];
  render();
}

async function loadHistory() {
  if (!state.customer.customer_id) return;
  const now = new Date();
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
  const { data } = await supabase.from('orders')
    .select('*, order_items(*, menu(*))')
    .eq('customer_id', state.customer.customer_id)
    .gte('created_at', startOfMonth)
    .order('created_at', { ascending: false });
  state.history = data || [];
  render();
}

window.switchTab = (tab) => {
  state.tab = tab;
  document.querySelectorAll('.bottom-nav div').forEach((el, i) => {
    el.classList.toggle('active', ['menu', 'processing', 'history'][i] === tab);
  });
  if (tab === 'processing') loadOrders();
  if (tab === 'history') loadHistory();
  render();
};

window.updateQty = (itemId, delta) => {
  state.cart[itemId] = Math.max(0, (state.cart[itemId] || 0) + delta);
  if (state.cart[itemId] === 0) delete state.cart[itemId];
  render();
};

window.checkout = async () => {
  const total = Object.entries(state.cart).reduce((sum, [id, qty]) => {
    const item = state.menu.find(m => m.item_id == id);
    return sum + (item?.price || 0) * qty;
  }, 0);
  
  if (total < 100) {
    showToast('Add items worth at least ₹100 to continue');
    return;
  }
  
  state.checkoutStep = 'details';
  render();
};

window.placeOrder = async () => {
  const name = document.getElementById('custName').value;
  const phone = document.getElementById('custPhone').value;
  const address = document.getElementById('custAddress').value;
  const city = document.getElementById('custCity').value;
  const instructions = document.getElementById('deliveryInst').value;
  const specialInst = document.getElementById('specialInst').value;
  const deliveryType = document.getElementById('deliveryType').value;
  
  if (!name || !phone || !address) {
    showToast('Please fill all required fields');
    return;
  }
  
  let customerId = state.customer.customer_id;
  
  if (!customerId) {
    const { data: existing } = await supabase.from('customers').select('*').eq('phone', phone).single();
    if (existing) {
      customerId = existing.customer_id;
      state.customer = existing;
    } else {
      const { data: newCust } = await supabase.from('customers').insert({
        name, phone, address, city_id: state.selectedCity
      }).select().single();
      customerId = newCust.customer_id;
      state.customer = newCust;
    }
    localStorage.setItem('customer', JSON.stringify(state.customer));
  }
  
  const items = Object.entries(state.cart).map(([id, qty]) => {
    const item = state.menu.find(m => m.item_id == id);
    return { item_id: id, chef_id: item.chef_id, quantity: qty, price_at_order_time: item.price, chef_amount: item.price * qty };
  });
  
  const subtotal = items.reduce((s, i) => s + i.chef_amount, 0);
  const deliveryAmount = deliveryType === 'delivery' ? 30 : 0;
  const platformFee = 10;
  const total = subtotal + deliveryAmount + platformFee;
  
  const { data: order } = await supabase.from('orders').insert({
    customer_id: customerId,
    city_id: state.selectedCity,
    delivery_type: deliveryType,
    current_status: 'placed',
    delivery_amount: deliveryAmount,
    platform_fee: platformFee,
    total_amount: total
  }).select().single();
  
  await supabase.from('order_items').insert(items.map(i => ({ ...i, order_id: order.order_id })));
  
  await supabase.from('order_status_history').insert({
    order_id: order.order_id,
    status: 'placed',
    changed_by: 'customer'
  });
  
  state.cart = {};
  state.checkoutStep = null;
  switchTab('processing');
  showToast('Order placed! Order #' + order.order_id);
};

window.updateCustomer = async () => {
  const name = document.getElementById('histName').value;
  const phone = document.getElementById('histPhone').value;
  const address = document.getElementById('histAddress').value;
  
  await supabase.from('customers').update({ name, phone, address }).eq('customer_id', state.customer.customer_id);
  state.customer = { ...state.customer, name, phone, address };
  localStorage.setItem('customer', JSON.stringify(state.customer));
  showToast('Details updated');
};

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 3000);
}

function render() {
  const app = document.getElementById('app');
  const proceedBar = document.getElementById('proceedBar');
  const totalPrice = document.getElementById('totalPrice');
  
  const cartTotal = Object.entries(state.cart).reduce((sum, [id, qty]) => {
    const item = state.menu.find(m => m.item_id == id);
    return sum + (item?.price || 0) * qty;
  }, 0);
  
  const hasItems = Object.keys(state.cart).length > 0;
  proceedBar.classList.toggle('hidden', !hasItems || state.tab !== 'menu' || state.checkoutStep);
  totalPrice.textContent = '₹' + cartTotal;
  proceedBar.querySelector('button').disabled = cartTotal < 100;
  
  if (state.checkoutStep === 'details') {
    const items = Object.entries(state.cart).map(([id, qty]) => {
      const item = state.menu.find(m => m.item_id == id);
      return `<div><span>${item.item_name} x${qty}</span><span>₹${item.price * qty}</span></div>`;
    }).join('');
    
    const deliveryFee = 30;
    const platformFee = 10;
    const total = cartTotal + deliveryFee + platformFee;
    
    app.innerHTML = `<div class="container checkout">
      <h2>Order Summary</h2>
      <div class="item-list">${items}</div>
      <div class="total">Subtotal: ₹${cartTotal}</div>
      
      <label>Special Instructions for Chef</label>
      <textarea id="specialInst" rows="2"></textarea>
      
      <label>Name *</label>
      <input id="custName" value="${state.customer.name || ''}" required>
      
      <label>Phone *</label>
      <input id="custPhone" value="${state.customer.phone || ''}" required>
      
      <label>Address *</label>
      <textarea id="custAddress" rows="2" required>${state.customer.address || ''}</textarea>
      
      <input type="hidden" id="custCity" value="${state.selectedCity}">
      
      <label>Delivery Instructions</label>
      <input id="deliveryInst">
      
      <label>Delivery Option</label>
      <select id="deliveryType">
        <option value="delivery">Home Delivery (₹30)</option>
        <option value="self_pickup">Pickup from Chef (Free)</option>
      </select>
      
      <div style="margin-top: 16px; padding: 12px; background: #f9f9f9; border-radius: 6px;">
        <div style="display: flex; justify-content: space-between; margin: 4px 0;">
          <span>Delivery Fee</span><span>₹30</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin: 4px 0;">
          <span>Platform Fee</span><span>₹10</span>
        </div>
        <div class="total">Total: ₹${total}</div>
      </div>
      
      <button onclick="placeOrder()" style="width: 100%; margin-top: 16px; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">Place Order</button>
      <button onclick="state.checkoutStep = null; render();" style="width: 100%; margin-top: 8px; padding: 14px; background: white; color: var(--primary); border: 1px solid var(--border); border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;">Back</button>
    </div>`;
    return;
  }
  
  if (state.tab === 'menu') {
    let html = '<div class="container">';
    
    html += '<select onchange="loadChefs(this.value); state.selectedCity = this.value;"><option value="">Select City</option>';
    state.cities.forEach(c => html += `<option value="${c.city_id}">${c.city_name}</option>`);
    html += '</select>';
    
    if (state.selectedCity) {
      html += '<select onchange="loadMenu(this.value)"><option value="">Select Chef</option>';
      state.chefs.forEach(c => html += `<option value="${c.chef_id}">${c.name}</option>`);
      html += '</select>';
    }
    
    state.menu.forEach(item => {
      const qty = state.cart[item.item_id] || 0;
      html += `<div class="menu-item">
        <div class="left">
          <h3>${item.item_name}</h3>
          <div class="price">₹${item.price}</div>
          <div class="controls">
            <button onclick="updateQty(${item.item_id}, -1)" ${qty === 0 ? 'disabled' : ''}>−</button>
            <button onclick="updateQty(${item.item_id}, 1)">+</button>
          </div>
        </div>
        <div class="img-wrap">
          <img src="${item.image_url}" alt="${item.item_name}">
          ${qty > 0 ? `<div class="badge">${qty}</div>` : ''}
        </div>
      </div>`;
    });
    
    html += '</div>';
    app.innerHTML = html;
  }
  
  if (state.tab === 'processing') {
    let html = '<div class="container">';
    if (state.orders.length === 0) {
      html += '<p style="text-align: center; margin-top: 40px; color: var(--secondary);">No active orders</p>';
    } else {
      state.orders.forEach(order => {
        const statusMap = {
          placed: 'Waiting for chef approval',
          accepted: 'Accepted by chef',
          prepared: 'Being prepared',
          picked_up: 'Out for delivery',
          delivered: 'Delivered'
        };
        html += `<div class="order-card">
          <h4>Order #${order.order_id}</h4>
          ${order.order_items.map(i => `<div style="font-size: 13px;">${i.menu.item_name} x${i.quantity}</div>`).join('')}
          <div style="font-weight: 600; margin-top: 8px;">₹${order.total_amount}</div>
          <div class="status">${statusMap[order.current_status]}</div>
        </div>`;
      });
    }
    html += '</div>';
    app.innerHTML = html;
  }
  
  if (state.tab === 'history') {
    let html = '<div class="container">';
    html += `<h3 style="margin: 16px 0;">Your Details</h3>
      <label>Name</label>
      <input id="histName" value="${state.customer.name || ''}">
      <label>Phone</label>
      <input id="histPhone" value="${state.customer.phone || ''}">
      <label>Address</label>
      <textarea id="histAddress" rows="2">${state.customer.address || ''}</textarea>
      <button onclick="updateCustomer()" style="margin-top: 8px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">Update</button>
      
      <h3 style="margin: 24px 0 16px;">This Month's Orders</h3>`;
    
    (state.history || []).forEach(order => {
      html += `<div class="order-card">
        <h4>Order #${order.order_id}</h4>
        <div style="font-size: 12px; color: var(--secondary);">${new Date(order.created_at).toLocaleDateString()}</div>
        ${order.order_items.map(i => `<div style="font-size: 13px;">${i.menu.item_name} x${i.quantity}</div>`).join('')}
        <div style="font-weight: 600; margin-top: 8px;">₹${order.total_amount}</div>
      </div>`;
    });
    html += '</div>';
    app.innerHTML = html;
  }
}

window.supabase = supabase;
window.loadChefs = loadChefs;
window.loadMenu = loadMenu;
window.loadOrders = loadOrders;

loadCities();
initFCM();
render();
</script>

</body>
</html>