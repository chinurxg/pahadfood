<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pahad Food - Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root { 
  --primary: #1a1a1a; 
  --secondary: #666; 
  --border: #e0e0e0; 
  --bg: #fff; 
  --success: #2e7d32; 
  --danger: #d32f2f; 
  --warning: #ff9800; 
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: 'Inter', sans-serif; 
  background: #f5f5f5; 
  color: var(--primary); 
}
.top-bar { 
  background: var(--primary); 
  color: white; 
  padding: 20px 24px; 
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.top-bar h1 { 
  font-family: 'Playfair Display', serif; 
  font-size: 2rem; 
  margin-bottom: 4px;
}
.top-bar .subtitle { 
  font-size: 14px; 
  opacity: 0.9; 
}
.container { 
  max-width: 1200px; 
  margin: 0 auto; 
  padding: 24px; 
}
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}
.stat-card {
  background: white;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-left: 4px solid var(--primary);
}
.stat-card.danger { border-left-color: var(--danger); }
.stat-card.success { border-left-color: var(--success); }
.stat-card.warning { border-left-color: var(--warning); }
.stat-card .label {
  font-size: 14px;
  color: var(--secondary);
  margin-bottom: 8px;
}
.stat-card .value {
  font-size: 36px;
  font-weight: 700;
  color: var(--primary);
}
.section {
  background: white;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.section h2 {
  font-size: 20px;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--border);
}
.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  border-bottom: 2px solid var(--border);
}
.tab {
  padding: 12px 24px;
  cursor: pointer;
  font-weight: 500;
  color: var(--secondary);
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  transition: all 0.2s;
}
.tab.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}
.tab:hover {
  color: var(--primary);
}
.partner-table {
  width: 100%;
  border-collapse: collapse;
}
.partner-table thead {
  background: #f8f9fa;
}
.partner-table th {
  text-align: left;
  padding: 12px;
  font-weight: 600;
  font-size: 14px;
  color: var(--secondary);
}
.partner-table td {
  padding: 16px 12px;
  border-bottom: 1px solid var(--border);
}
.partner-table tr:hover {
  background: #f8f9fa;
}
.status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}
.status-badge.paid {
  background: #e8f5e9;
  color: var(--success);
}
.status-badge.pending {
  background: #fff3e0;
  color: var(--warning);
}
.status-badge.overdue {
  background: #ffebee;
  color: var(--danger);
}
.amount-cell {
  font-weight: 700;
  font-size: 16px;
}
.amount-cell.pending {
  color: var(--danger);
}
.amount-cell.paid {
  color: var(--success);
}
button {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
}
button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.btn-reset {
  background: var(--success);
  color: white;
}
.btn-reset:hover:not(:disabled) {
  opacity: 0.9;
}
.btn-remind {
  background: var(--warning);
  color: white;
  margin-right: 8px;
}
.btn-remind:hover:not(:disabled) {
  opacity: 0.9;
}
.btn-whatsapp {
  background: #25d366;
  color: white;
  text-decoration: none;
  display: inline-block;
  margin-right: 8px;
}
.btn-whatsapp:hover {
  opacity: 0.9;
}
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--secondary);
}
.empty-state .icon {
  font-size: 48px;
  margin-bottom: 16px;
}
.login-container {
  max-width: 400px;
  margin: 100px auto;
  padding: 32px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.login-container h2 {
  text-align: center;
  margin-bottom: 24px;
}
input {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 15px;
}
.hidden {
  display: none !important;
}
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: white;
  padding: 16px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 1000;
  animation: slideIn 0.3s ease-out;
  border-left: 4px solid var(--success);
}
.toast.error {
  border-left-color: var(--danger);
}
@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}
.filters {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.filter-btn {
  padding: 8px 16px;
  background: white;
  border: 2px solid var(--border);
  color: var(--secondary);
}
.filter-btn.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}
.partner-name {
  font-weight: 600;
  font-size: 15px;
}
.partner-type {
  font-size: 13px;
  color: var(--secondary);
  margin-top: 2px;
}
</style>
</head>
<body>

<div id="loginScreen">
  <div class="login-container">
    <h2>Admin Login</h2>
    <input type="password" id="adminPassword" placeholder="Admin Password" onkeypress="if(event.key==='Enter') adminLogin()">
    <button onclick="adminLogin()" style="width: 100%; margin-top: 8px; background: var(--primary); color: white;">Login</button>
    <div style="margin-top: 12px; text-align: center; font-size: 13px; color: var(--secondary);">
      Default password: 1q2w3e
    </div>
  </div>
</div>

<div id="adminApp" class="hidden">
  <div class="top-bar">
    <h1>Pahad Food Admin</h1>
    <div class="subtitle">Platform Fee Management Dashboard</div>
  </div>

  <div class="container">
    <div class="stats-grid">
      <div class="stat-card danger">
        <div class="label">Total Pending Fees</div>
        <div class="value" id="totalPending">â‚¹0</div>
      </div>
      <div class="stat-card success">
        <div class="label">Collected This Month</div>
        <div class="value" id="totalCollected">â‚¹0</div>
      </div>
      <div class="stat-card warning">
        <div class="label">Partners with Dues</div>
        <div class="value" id="partnersDue">0</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Partners</div>
        <div class="value" id="totalPartners">0</div>
      </div>
    </div>

    <div class="section">
      <h2>Partner Payments</h2>
      
      <div class="tabs">
        <div class="tab active" onclick="switchTab('all')">All Partners</div>
        <div class="tab" onclick="switchTab('chefs')">Chefs</div>
        <div class="tab" onclick="switchTab('delivery')">Delivery Partners</div>
      </div>

      <div class="filters">
        <button class="filter-btn active" onclick="filterStatus('all')">All Status</button>
        <button class="filter-btn" onclick="filterStatus('pending')">Pending Only</button>
        <button class="filter-btn" onclick="filterStatus('paid')">Paid Only</button>
      </div>

      <div id="partnersTable"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const adminSupabase = window.supabase.createClient(
  'https://zjuugofcrnieigciaclb.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqdXVnb2Zjcm5pZWlnY2lhY2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzY4ODYsImV4cCI6MjA4NTU1Mjg4Nn0.pAMtzCz5aM7vxGT_ZVK7TPzumdFXoroQfxaCUt8xmVI'
);

const ADMIN_PASSWORD = '1q2w3e'; // Change this!
const WHATSAPP_NUMBER = '917876602575'; // Your WhatsApp number

let state = {
  tab: 'all',
  filter: 'all',
  partners: [],
  loading: false
};

function showToast(message, isError = false) {
  const toast = document.createElement('div');
  toast.className = `toast ${isError ? 'error' : ''}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

window.adminLogin = function() {
  const password = document.getElementById('adminPassword').value.trim();
  
  if (!password) {
    showToast('Please enter password', true);
    return;
  }
  
  if (password === ADMIN_PASSWORD) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('adminApp').classList.remove('hidden');
    loadPartners();
    showToast('Welcome, Admin!');
  } else {
    showToast('Invalid password', true);
    document.getElementById('adminPassword').value = '';
    document.getElementById('adminPassword').focus();
  }
}

window.switchTab = function(tab) {
  state.tab = tab;
  document.querySelectorAll('.tab').forEach((el, i) => {
    el.classList.toggle('active', ['all', 'chefs', 'delivery'][i] === tab);
  });
  render();
}

window.filterStatus = function(filter) {
  state.filter = filter;
  document.querySelectorAll('.filter-btn').forEach((el, i) => {
    el.classList.toggle('active', ['all', 'pending', 'paid'][i] === filter);
  });
  render();
}

async function loadPartners() {
  state.loading = true;
  
  try {
    const now = new Date();
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
    
    // Load chefs
    const { data: chefs } = await adminSupabase.from('chefs').select('*');
    
    // Load delivery partners
    const { data: deliverers } = await adminSupabase.from('deliverers').select('*');
    
    // Calculate fees for each partner
    const partnersWithFees = [];
    
    // Process chefs
    for (const chef of chefs || []) {
      const { data: orders } = await adminSupabase.from('orders')
        .select('*')
        .eq('delivered_by_chef_id', chef.chef_id)
        .eq('current_status', 'delivered')
        .gte('created_at', startOfMonth);
      
      const selfDeliveryCount = (orders || []).length;
      const platformFee = selfDeliveryCount * 10;
      
      partnersWithFees.push({
        id: chef.chef_id,
        name: chef.name,
        phone: chef.phone,
        type: 'Chef',
        address: chef.address,
        deliveryCount: selfDeliveryCount,
        platformFee: platformFee,
        isPaid: platformFee === 0 || chef.fee_paid_this_month === true,
        lastPaidDate: chef.last_fee_payment_date
      });
    }
    
    // Process delivery partners
    for (const deliverer of deliverers || []) {
      const { data: orders } = await adminSupabase.from('orders')
        .select('*')
        .eq('delivery_person_id', deliverer.deliverer_id)
        .eq('current_status', 'delivered')
        .gte('created_at', startOfMonth);
      
      const deliveryCount = (orders || []).length;
      const platformFee = deliveryCount * 10;
      
      partnersWithFees.push({
        id: deliverer.deliverer_id,
        name: deliverer.name,
        phone: deliverer.phone,
        type: 'Delivery Partner',
        deliveryCount: deliveryCount,
        platformFee: platformFee,
        isPaid: platformFee === 0 || deliverer.fee_paid_this_month === true,
        lastPaidDate: deliverer.last_fee_payment_date
      });
    }
    
    state.partners = partnersWithFees;
    
  } catch (error) {
    console.error('Error loading partners:', error);
    showToast('Error loading data', true);
  }
  
  state.loading = false;
  render();
}

function getWhatsAppLink(partner) {
  const message = `Hey! I'm ${partner.name} (${partner.type}). I'm paying â‚¹${partner.platformFee} platform fee for this month. Please confirm and reset my service fee indicator. Thank you!`;
  return `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
}

window.markAsPaid = async function(partnerId, partnerType) {
  try {
    const table = partnerType === 'Chef' ? 'chefs' : 'deliverers';
    const idField = partnerType === 'Chef' ? 'chef_id' : 'deliverer_id';
    
    await adminSupabase.from(table).update({
      fee_paid_this_month: true,
      last_fee_payment_date: new Date().toISOString()
    }).eq(idField, partnerId);
    
    showToast('Payment marked as received!');
    loadPartners();
  } catch (error) {
    console.error('Error marking as paid:', error);
    showToast('Error updating payment status', true);
  }
}

window.resetMonthlyFees = async function() {
  if (!confirm('Reset all monthly fees? This should be done at the start of each month.')) {
    return;
  }
  
  try {
    await adminSupabase.from('chefs').update({ fee_paid_this_month: false }).neq('chef_id', 0);
    await adminSupabase.from('deliverers').update({ fee_paid_this_month: false }).neq('deliverer_id', 0);
    
    showToast('Monthly fees reset successfully!');
    loadPartners();
  } catch (error) {
    console.error('Error resetting fees:', error);
    showToast('Error resetting fees', true);
  }
}

function render() {
  // Calculate stats
  let totalPending = 0;
  let totalCollected = 0;
  let partnersDue = 0;
  
  state.partners.forEach(p => {
    if (p.isPaid) {
      totalCollected += p.platformFee;
    } else if (p.platformFee > 0) {
      totalPending += p.platformFee;
      partnersDue++;
    }
  });
  
  document.getElementById('totalPending').textContent = `â‚¹${totalPending}`;
  document.getElementById('totalCollected').textContent = `â‚¹${totalCollected}`;
  document.getElementById('partnersDue').textContent = partnersDue;
  document.getElementById('totalPartners').textContent = state.partners.length;
  
  // Filter partners
  let filteredPartners = state.partners;
  
  // Filter by tab
  if (state.tab === 'chefs') {
    filteredPartners = filteredPartners.filter(p => p.type === 'Chef');
  } else if (state.tab === 'delivery') {
    filteredPartners = filteredPartners.filter(p => p.type === 'Delivery Partner');
  }
  
  // Filter by status
  if (state.filter === 'pending') {
    filteredPartners = filteredPartners.filter(p => !p.isPaid && p.platformFee > 0);
  } else if (state.filter === 'paid') {
    filteredPartners = filteredPartners.filter(p => p.isPaid && p.platformFee > 0);
  }
  
  // Sort: pending first, then by amount
  filteredPartners.sort((a, b) => {
    if (!a.isPaid && b.isPaid) return -1;
    if (a.isPaid && !b.isPaid) return 1;
    return b.platformFee - a.platformFee;
  });
  
  // Render table
  let html = '';
  
  if (filteredPartners.length === 0) {
    html = `<div class="empty-state">
      <div class="icon">ðŸ“Š</div>
      <p>No partners found</p>
    </div>`;
  } else {
    html = `
      <table class="partner-table">
        <thead>
          <tr>
            <th>Partner</th>
            <th>Type</th>
            <th>Deliveries</th>
            <th>Platform Fee</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    filteredPartners.forEach(partner => {
      const status = partner.platformFee === 0 ? 'paid' : (partner.isPaid ? 'paid' : 'pending');
      const statusText = partner.platformFee === 0 ? 'No Dues' : (partner.isPaid ? 'Paid' : 'Pending');
      
      html += `
        <tr>
          <td>
            <div class="partner-name">${partner.name}</div>
            <div class="partner-type">${partner.phone}</div>
          </td>
          <td>${partner.type}</td>
          <td>${partner.deliveryCount}</td>
          <td>
            <span class="amount-cell ${partner.isPaid || partner.platformFee === 0 ? 'paid' : 'pending'}">
              â‚¹${partner.platformFee}
            </span>
          </td>
          <td>
            <span class="status-badge ${status}">${statusText}</span>
          </td>
          <td>
            ${partner.platformFee > 0 && !partner.isPaid ? `
              <a href="${getWhatsAppLink(partner)}" target="_blank" class="btn-whatsapp">
                ðŸ’¬ WhatsApp
              </a>
              <button class="btn-reset" onclick="markAsPaid(${partner.id}, '${partner.type}')">
                âœ“ Mark Paid
              </button>
            ` : partner.platformFee > 0 ? `
              <span style="color: var(--success); font-weight: 600;">âœ“ Paid</span>
            ` : `
              <span style="color: var(--secondary);">No dues</span>
            `}
          </td>
        </tr>
      `;
    });
    
    html += `
        </tbody>
      </table>
    `;
  }
  
  document.getElementById('partnersTable').innerHTML = html;
}

// Auto-refresh every 30 seconds
setInterval(() => {
  if (!document.getElementById('adminApp').classList.contains('hidden')) {
    loadPartners();
  }
}, 30000);
</script>

</body>
</html>