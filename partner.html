<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pahad Food Partner</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root { --primary: #1a1a1a; --secondary: #666; --border: #e0e0e0; --bg: #fff; }
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--primary); }
.top-bar { background: var(--primary); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; }
.top-bar h2 { font-family: 'Playfair Display', serif; font-size: 1.5rem; }
.container { padding: 16px; max-width: 600px; margin: 0 auto; padding-bottom: 80px; }
input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 4px; font-size: 15px; font-family: inherit; }
button { padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin: 4px; }
button.secondary { background: white; color: var(--primary); border: 1px solid var(--border); }
button.danger { background: #d32f2f; }
.order-card { border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin: 12px 0; }
.order-card h4 { font-size: 16px; margin-bottom: 8px; }
.order-card .meta { font-size: 13px; color: var(--secondary); margin: 4px 0; }
.order-card .items { margin: 8px 0; font-size: 14px; }
.order-card .actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
.section { margin: 24px 0; }
.section h3 { font-size: 18px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--border); }
.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg); border-top: 1px solid var(--border); display: flex; z-index: 101; }
.bottom-nav div { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-size: 14px; font-weight: 500; }
.bottom-nav div.active { color: var(--primary); border-top: 2px solid var(--primary); }
.bottom-nav div:not(.active) { color: var(--secondary); }
.login-form { max-width: 400px; margin: 100px auto; padding: 24px; border: 1px solid var(--border); border-radius: 8px; }
.login-form h2 { margin-bottom: 16px; }
.hidden { display: none !important; }
label { display: block; font-size: 14px; margin: 12px 0 4px; font-weight: 500; }
.stat-box { background: #f9f9f9; padding: 12px; border-radius: 6px; margin: 8px 0; }
.stat-box .label { font-size: 13px; color: var(--secondary); }
.stat-box .value { font-size: 20px; font-weight: 600; margin-top: 4px; }
</style>
</head>
<body>

<div id="loginScreen">
  <div class="login-form">
    <h2>Partner Login</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()" style="width: 100%; margin-top: 8px;">Login</button>
  </div>
</div>

<div id="mainApp" class="hidden">
  <div class="top-bar">
    <h2>Pahad Food</h2>
    <span id="userName"></span>
  </div>
  
  <div id="appContent"></div>
  
  <div class="bottom-nav">
    <div class="active" onclick="switchTab('orders')">Orders</div>
    <div onclick="switchTab('history')">History</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';

const supabase = window.supabase.createClient(
  'https://zjuugofcrnieigciaclb.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqdXVnb2Zjcm5pZWlnY2lhY2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzY4ODYsImV4cCI6MjA4NTU1Mjg4Nn0.pAMtzCz5aM7vxGT_ZVK7TPzumdFXoroQfxaCUt8xmVI'
);

const firebaseConfig = {
  apiKey: "AIzaSyAGYjiyPqt7sNAFND9I22AIs7wGh6gB7pQ",
  projectId: "pahadfood",
  messagingSenderId: "93650163842",
  appId: "1:93650163842:android:afe5f5016e4410fa6ebc9b"
};

const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

window.state = { 
  tab: 'orders', 
  user: JSON.parse(localStorage.getItem('partner') || 'null'),
  orders: [],
  stats: {}
};

async function initFCM() {
  try {
    const token = await getToken(messaging, { vapidKey: 'BJCgA4WI7ZNbRXF86toihrZbLABf0XURwSMNXxMQZXnxDJLSkk61cWQ2lJbOFzvrrkWeH-H-DZakZzMQ30adlws' });
    if (token && state.user) {
      const table = state.user.role === 'chef' ? 'chefs' : 'deliverers';
      const idField = state.user.role === 'chef' ? 'chef_id' : 'deliverer_id';
      await supabase.from(table).update({ fcm_token: token }).eq(idField, state.user.id);
    }
  } catch (e) { console.error('FCM error:', e); }
}

onMessage(messaging, (payload) => {
  alert(payload.notification.title);
  loadOrders();
});

window.login = async () => {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  
  // Try chef login
  const { data: chef } = await supabase.from('chefs').select('*').eq('phone', username).single();
  if (chef && chef.password_hash === password) {
    state.user = { id: chef.chef_id, role: 'chef', name: chef.name, phone: chef.phone, address: chef.address, city_id: chef.city_id };
    localStorage.setItem('partner', JSON.stringify(state.user));
    showApp();
    return;
  }
  
  // Try delivery login
  const { data: delivery } = await supabase.from('deliverers').select('*').eq('phone', username).single();
  if (delivery && delivery.phone === password) {
    state.user = { id: delivery.deliverer_id, role: 'delivery', name: delivery.name, phone: delivery.phone, city_id: delivery.city_id };
    localStorage.setItem('partner', JSON.stringify(state.user));
    showApp();
    return;
  }
  
  alert('Invalid credentials');
};

function showApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('mainApp').classList.remove('hidden');
  document.getElementById('userName').textContent = state.user.name;
  initFCM();
  loadOrders();
}

window.switchTab = (tab) => {
  state.tab = tab;
  document.querySelectorAll('.bottom-nav div').forEach((el, i) => {
    el.classList.toggle('active', ['orders', 'history'][i] === tab);
  });
  if (tab === 'orders') loadOrders();
  if (tab === 'history') loadStats();
  render();
};

async function loadOrders() {
  if (state.user.role === 'chef') {
    const { data: items } = await supabase.from('order_items')
      .select('*, orders(*, customers(*)), menu(*)')
      .eq('chef_id', state.user.id)
      .in('orders.current_status', ['placed', 'accepted', 'prepared']);
    
    const ordersMap = {};
    items?.forEach(item => {
      const orderId = item.orders.order_id;
      if (!ordersMap[orderId]) ordersMap[orderId] = { ...item.orders, items: [] };
      ordersMap[orderId].items.push(item);
    });
    
    state.orders = Object.values(ordersMap);
  } else {
    const { data } = await supabase.from('orders')
      .select('*, order_items(*, menu(*)), customers(*)')
      .eq('city_id', state.user.city_id)
      .eq('delivery_type', 'delivery')
      .in('current_status', ['accepted', 'prepared', 'picked_up']);
    
    state.orders = data || [];
  }
  render();
}

async function loadStats() {
  const now = new Date();
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
  
  if (state.user.role === 'chef') {
    const { data: items } = await supabase.from('order_items')
      .select('*, orders(*)')
      .eq('chef_id', state.user.id)
      .gte('orders.created_at', startOfMonth);
    
    const accepted = items?.filter(i => i.orders.current_status !== 'cancelled') || [];
    const revenue = accepted.reduce((s, i) => s + i.chef_amount, 0);
    const serviceFee = accepted.filter(i => i.orders.delivery_type === 'self_pickup').reduce((s, i) => s + i.chef_amount * 0.05, 0);
    
    state.stats = {
      revenue,
      serviceFee,
      accepted: accepted.length,
      rejected: (items?.length || 0) - accepted.length
    };
  } else {
    const { data: orders } = await supabase.from('orders')
      .select('*')
      .eq('delivery_person_id', state.user.id)
      .gte('created_at', startOfMonth);
    
    const completed = orders?.filter(o => o.current_status === 'delivered') || [];
    const revenue = completed.reduce((s, o) => s + o.delivery_amount, 0);
    const serviceFee = revenue * 0.3;
    
    state.stats = {
      revenue,
      serviceFee,
      profit: revenue - serviceFee,
      completed: completed.length
    };
  }
  render();
}

window.acceptOrder = async (orderId, withDelivery = false) => {
  await supabase.from('orders').update({ current_status: 'accepted' }).eq('order_id', orderId);
  await supabase.from('order_status_history').insert({ order_id: orderId, status: 'accepted', changed_by: 'chef' });
  loadOrders();
};

window.rejectOrder = async (orderId) => {
  const reason = prompt('Reason for rejection:');
  if (!reason) return;
  await supabase.from('orders').update({ current_status: 'cancelled' }).eq('order_id', orderId);
  await supabase.from('order_status_history').insert({ order_id: orderId, status: 'cancelled', changed_by: 'chef' });
  // TODO: Call customer
  loadOrders();
};

window.markDone = async (orderId) => {
  await supabase.from('orders').update({ current_status: 'prepared' }).eq('order_id', orderId);
  await supabase.from('order_status_history').insert({ order_id: orderId, status: 'prepared', changed_by: 'chef' });
  loadOrders();
};

window.acceptDelivery = async (orderId) => {
  await supabase.from('orders').update({ delivery_person_id: state.user.id }).eq('order_id', orderId);
  loadOrders();
};

window.markPickedUp = async (orderId) => {
  await supabase.from('orders').update({ current_status: 'picked_up' }).eq('order_id', orderId);
  await supabase.from('order_status_history').insert({ order_id: orderId, status: 'picked_up', changed_by: 'delivery' });
  loadOrders();
};

window.markDelivered = async (orderId) => {
  await supabase.from('orders').update({ current_status: 'delivered' }).eq('order_id', orderId);
  await supabase.from('order_status_history').insert({ order_id: orderId, status: 'delivered', changed_by: 'delivery' });
  loadOrders();
};

function render() {
  const content = document.getElementById('appContent');
  
  if (state.tab === 'orders') {
    let html = '<div class="container">';
    
    if (state.user.role === 'chef') {
      const unanswered = state.orders.filter(o => o.current_status === 'placed');
      const current = state.orders.filter(o => o.current_status === 'accepted');
      
      html += '<div class="section"><h3>Unanswered</h3>';
      unanswered.forEach(order => {
        html += `<div class="order-card">
          <h4>Order #${order.order_id}</h4>
          <div class="meta">${order.customers.name} • ${order.customers.address}</div>
          <div class="items">${order.items.map(i => `${i.menu.item_name} x${i.quantity}`).join(', ')}</div>
          <div style="font-weight: 600; margin-top: 8px;">₹${order.total_amount}</div>
          <div class="actions">
            <button class="danger" onclick="rejectOrder(${order.order_id})">Reject & Call</button>
            <button onclick="acceptOrder(${order.order_id})">Accept</button>
            ${order.delivery_type === 'delivery' ? `<button onclick="acceptOrder(${order.order_id}, true)">Accept & Deliver</button>` : ''}
          </div>
        </div>`;
      });
      html += '</div>';
      
      html += '<div class="section"><h3>Current</h3>';
      current.forEach(order => {
        html += `<div class="order-card">
          <h4>Order #${order.order_id}</h4>
          <div class="items">${order.items.map(i => `${i.menu.item_name} x${i.quantity}`).join(', ')}</div>
          <div class="actions">
            <button onclick="markDone(${order.order_id})">Done</button>
          </div>
        </div>`;
      });
      html += '</div>';
    } else {
      const unanswered = state.orders.filter(o => o.current_status === 'accepted' && !o.delivery_person_id);
      const preparing = state.orders.filter(o => o.current_status === 'accepted' && o.delivery_person_id === state.user.id);
      const current = state.orders.filter(o => ['prepared', 'picked_up'].includes(o.current_status) && o.delivery_person_id === state.user.id);
      
      html += '<div class="section"><h3>Unanswered</h3>';
      unanswered.forEach(order => {
        html += `<div class="order-card">
          <h4>Order #${order.order_id}</h4>
          <div class="meta">Pickup: ${order.order_items[0]?.menu?.item_name ? 'Chef location' : 'N/A'}</div>
          <div style="font-weight: 600;">₹${order.delivery_amount}</div>
          <div class="actions">
            <button onclick="acceptDelivery(${order.order_id})">Accept</button>
          </div>
        </div>`;
      });
      html += '</div>';
      
      html += '<div class="section"><h3>Current</h3>';
      current.forEach(order => {
        const isPicked = order.current_status === 'picked_up';
        html += `<div class="order-card">
          <h4>Order #${order.order_id}</h4>
          <div class="meta">${isPicked ? 'Deliver to' : 'Pickup from'}: ${isPicked ? order.customers.address : 'Chef'}</div>
          <div style="font-weight: 600;">Collect: ₹${order.total_amount} | Pay Chef: ₹${order.total_amount - order.delivery_amount - order.platform_fee}</div>
          <div class="actions">
            ${!isPicked ? `<button onclick="markPickedUp(${order.order_id})">Picked Up</button>` : ''}
            ${isPicked ? `<button onclick="markDelivered(${order.order_id})">Delivered</button>` : ''}
          </div>
        </div>`;
      });
      html += '</div>';
    }
    
    html += '</div>';
    content.innerHTML = html;
  }
  
  if (state.tab === 'history') {
    let html = '<div class="container">';
    html += `<h3>Profile</h3>
      <label>Name</label>
      <input value="${state.user.name}" readonly>
      <label>Phone</label>
      <input value="${state.user.phone}" readonly>
      ${state.user.address ? `<label>Address</label><textarea readonly rows="2">${state.user.address}</textarea>` : ''}
      
      <h3 style="margin-top: 24px;">This Month</h3>`;
    
    if (state.user.role === 'chef') {
      html += `
        <div class="stat-box"><div class="label">Total Revenue</div><div class="value">₹${state.stats.revenue || 0}</div></div>
        <div class="stat-box"><div class="label">Service Fee</div><div class="value">₹${state.stats.serviceFee || 0}</div></div>
        <div class="stat-box"><div class="label">Orders Accepted</div><div class="value">${state.stats.accepted || 0}</div></div>
        <div class="stat-box"><div class="label">Orders Rejected</div><div class="value">${state.stats.rejected || 0}</div></div>
        <button ${(state.stats.revenue || 0) === 0 ? 'disabled' : ''}>Pay via UPI</button>`;
    } else {
      html += `
        <div class="stat-box"><div class="label">Total Revenue</div><div class="value">₹${state.stats.revenue || 0}</div></div>
        <div class="stat-box"><div class="label">Service Fee</div><div class="value">₹${state.stats.serviceFee || 0}</div></div>
        <div class="stat-box"><div class="label">Profit</div><div class="value">₹${state.stats.profit || 0}</div></div>
        <div class="stat-box"><div class="label">Completed</div><div class="value">${state.stats.completed || 0}</div></div>
        <button ${(state.stats.profit || 0) === 0 ? 'disabled' : ''}>Pay via UPI</button>`;
    }
    
    html += '</div>';
    content.innerHTML = html;
  }
}

if (state.user) {
  showApp();
}

window.supabase = supabase;
</script>

</body>
</html>