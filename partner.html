<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pahad Food Partner</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root { --primary: #1a1a1a; --secondary: #666; --border: #e0e0e0; --bg: #fff; --success: #2e7d32; --danger: #d32f2f; --warning: #ff9800; }
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', sans-serif; background: #fafafa; color: var(--primary); }
.top-bar { 
  background: var(--primary); color: white; padding: 16px; 
  display: flex; justify-content: space-between; align-items: center; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.top-bar h2 { font-family: 'Playfair Display', serif; font-size: 1.5rem; }
.top-bar .user-info { font-size: 14px; opacity: 0.9; }
.top-bar .user-info div:first-child { font-weight: 600; }
.container { padding: 16px; max-width: 600px; margin: 0 auto; padding-bottom: 80px; }
input, select, textarea { 
  width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); 
  border-radius: 6px; font-size: 15px; font-family: inherit; background: white;
}
button { 
  padding: 12px 24px; background: var(--primary); color: white; border: none; 
  border-radius: 6px; font-weight: 600; cursor: pointer; margin: 4px; 
  transition: opacity 0.2s;
}
button:hover { opacity: 0.9; }
button.secondary { background: white; color: var(--primary); border: 1px solid var(--border); }
button.danger { background: var(--danger); }
button.success { background: var(--success); }
button.warning { background: var(--warning); }
button:disabled { opacity: 0.5; cursor: not-allowed; }
.order-card { 
  border: 1px solid var(--border); border-radius: 8px; padding: 14px; margin: 12px 0; 
  background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  animation: slideIn 0.3s ease-out;
}
@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
.order-card.new-order {
  border: 2px solid var(--warning);
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
}
.order-card h4 { font-size: 16px; margin-bottom: 8px; font-weight: 600; }
.order-card .meta { font-size: 13px; color: var(--secondary); margin: 4px 0; }
.order-card .items { margin: 8px 0; font-size: 14px; line-height: 1.6; }
.order-card .items div { padding: 2px 0; }
.order-card .amount { font-weight: 700; font-size: 18px; margin: 12px 0; color: var(--primary); }
.order-card .amount.highlight { font-size: 22px; color: var(--success); }
.order-card .address { 
  background: #f5f5f5; padding: 10px; border-radius: 6px; margin: 8px 0;
  font-weight: 600; font-size: 15px;
}
.order-card .actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
.order-card .actions button { margin: 0; flex: 1; min-width: 120px; }
.section { margin: 24px 0; }
.section h3 { 
  font-size: 18px; margin-bottom: 12px; padding-bottom: 8px; 
  border-bottom: 2px solid var(--primary); font-weight: 600;
  display: flex; justify-content: space-between; align-items: center;
}
.section h3 .badge-count {
  background: var(--primary);
  color: white;
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
}
.bottom-nav { 
  position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg); 
  border-top: 1px solid var(--border); display: flex; z-index: 101; 
  box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
}
.bottom-nav div { 
  flex: 1; padding: 12px; text-align: center; cursor: pointer; 
  font-size: 14px; font-weight: 500; 
}
.bottom-nav div.active { color: var(--primary); border-top: 2px solid var(--primary); }
.bottom-nav div:not(.active) { color: var(--secondary); }
.login-form { 
  max-width: 400px; margin: 100px auto; padding: 32px; 
  border: 1px solid var(--border); border-radius: 12px; 
  background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.login-form h2 { margin-bottom: 24px; text-align: center; }
.hidden { display: none !important; }
label { display: block; font-size: 14px; margin: 12px 0 4px; font-weight: 500; }
.stat-box { 
  background: white; padding: 16px; border-radius: 8px; margin: 10px 0; 
  border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.stat-box .label { font-size: 13px; color: var(--secondary); }
.stat-box .value { font-size: 24px; font-weight: 700; margin-top: 4px; color: var(--primary); }

.stat-box.paid {
  background: #e8f5e9;
  border: 2px solid var(--success);
}

.stat-box.paid .value {
  color: var(--success);
}

.stat-box.paid .label {
  color: var(--success);
}

.stat-box.pending {
  background: #fff3e0;
  border: 2px solid var(--warning);
}

.shimmer-wrapper { padding: 16px; }
.shimmer { 
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 8px;
  margin: 12px 0;
  height: 120px;
}
@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--secondary);
}

.status-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 6px;
}
.status-new { background: #ff9800; }
.status-accepted { background: #2196f3; }
.status-preparing { background: #9c27b0; }
.status-ready { background: var(--success); }

.call-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: #4caf50;
  color: white;
  text-decoration: none;
  border-radius: 4px;
  font-size: 13px;
  margin-left: 8px;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 200;
  align-items: center;
  justify-content: center;
}
.modal.show { display: flex; }
.modal-content {
  background: white;
  padding: 24px;
  border-radius: 12px;
  max-width: 400px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}
.modal-content h3 { margin-bottom: 16px; }
.reason-option {
  padding: 12px;
  margin: 8px 0;
  border: 1px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}
.reason-option:hover {
  background: #f5f5f5;
  border-color: var(--primary);
}
.reason-option.selected {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.payment-pending {
  background: #fff3cd;
  border: 2px solid #ffc107;
}

.payment-breakdown {
  background: #f8f9fa;
  border: 2px solid #dee2e6;
  border-radius: 8px;
  padding: 12px;
  margin: 12px 0;
}

.payment-breakdown .row {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  font-size: 15px;
}

.payment-breakdown .row.total {
  border-top: 2px solid var(--primary);
  margin-top: 8px;
  padding-top: 12px;
  font-weight: 700;
  font-size: 18px;
  color: var(--success);
}

.payment-breakdown .row .label {
  color: var(--secondary);
}

/* Toast Notification Styles */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: white;
  padding: 16px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 300px;
  max-width: 400px;
  animation: slideInRight 0.3s ease-out;
  border-left: 4px solid var(--primary);
}
.toast.success { border-left-color: var(--success); }
.toast.error { border-left-color: var(--danger); }
.toast.warning { border-left-color: var(--warning); }
.toast.info { border-left-color: #2196f3; }

@keyframes slideInRight {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast .toast-icon {
  font-size: 24px;
  flex-shrink: 0;
}
.toast .toast-content {
  flex: 1;
}
.toast .toast-title {
  font-weight: 600;
  margin-bottom: 4px;
}
.toast .toast-message {
  font-size: 14px;
  color: var(--secondary);
}
.toast .toast-close {
  cursor: pointer;
  font-size: 20px;
  color: var(--secondary);
  flex-shrink: 0;
}

.load-more {
  text-align: center;
  padding: 20px;
}
.load-more button {
  width: 100%;
  max-width: 300px;
}

.payment-history {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 12px;
  margin: 12px 0;
}

.payment-history .history-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #dee2e6;
}

.payment-history .history-item:last-child {
  border-bottom: none;
}

.payment-history .history-label {
  font-size: 13px;
  color: var(--secondary);
}

.payment-history .history-value {
  font-weight: 600;
  color: var(--success);
}

.fee-summary {
  display: flex;
  gap: 12px;
  margin: 12px 0;
}

.fee-summary .fee-card {
  flex: 1;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
}

.fee-summary .fee-card.paid-card {
  background: #e8f5e9;
  border: 2px solid var(--success);
}

.fee-summary .fee-card.pending-card {
  background: #fff3e0;
  border: 2px solid var(--warning);
}

.fee-summary .fee-label {
  font-size: 12px;
  color: var(--secondary);
  margin-bottom: 4px;
}

.fee-summary .fee-value {
  font-size: 20px;
  font-weight: 700;
}

.fee-summary .paid-card .fee-value {
  color: var(--success);
}

.fee-summary .pending-card .fee-value {
  color: var(--warning);
}
</style>
</head>
<body>

<div id="loginScreen">
  <div class="login-form">
    <h2>Partner Login</h2>
    <input type="text" id="username" placeholder="Phone Number">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()" style="width: 100%; margin-top: 8px;">Login</button>
  </div>
</div>

<div id="mainApp" class="hidden">
  <div class="top-bar">
    <div>
      <h2>Pahad Food</h2>
      <div class="user-info">
        <div id="userName"></div>
        <div id="userRole" style="font-size: 12px; opacity: 0.8;"></div>
      </div>
    </div>
    <button onclick="logout()" style="padding: 8px 16px; margin: 0;">Logout</button>
  </div>
  
  <div id="appContent"></div>
  
  <div class="bottom-nav">
    <div class="active" onclick="switchTab('orders')">üìã Orders</div>
    <div onclick="switchTab('history')">üìä Profile</div>
  </div>
</div>

<div id="rejectModal" class="modal">
  <div class="modal-content">
    <h3>Reason for Rejection</h3>
    <div class="reason-option" onclick="selectReason('Out of stock')">Out of stock</div>
    <div class="reason-option" onclick="selectReason('Too busy')">Too busy</div>
    <div class="reason-option" onclick="selectReason('Closing soon')">Closing soon</div>
    <div class="reason-option" onclick="selectReason('Other')">Other</div>
    <div style="margin-top: 16px; display: flex; gap: 8px;">
      <button class="secondary" onclick="closeRejectModal()" style="flex: 1;">Cancel</button>
      <button class="danger" onclick="confirmReject()" style="flex: 1;" id="confirmRejectBtn" disabled>Reject Order</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';

const partnerSupabase = window.supabase.createClient(
  'https://zjuugofcrnieigciaclb.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqdXVnb2Zjcm5pZWlnY2lhY2xiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzY4ODYsImV4cCI6MjA4NTU1Mjg4Nn0.pAMtzCz5aM7vxGT_ZVK7TPzumdFXoroQfxaCUt8xmVI'
);

const firebaseConfig = {
  apiKey: "AIzaSyAGYjiyPqt7sNAFND9I22AIs7wGh6gB7pQ",
  projectId: "pahadfood",
  messagingSenderId: "93650163842",
  appId: "1:93650163842:android:afe5f5016e4410fa6ebc9b"
};

const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

window.state = { 
  tab: 'orders', 
  user: JSON.parse(localStorage.getItem('partner') || 'null'),
  orders: [],
  stats: {},
  loading: false,
  lastOrderIds: new Set(),
  rejectingOrderId: null,
  selectedRejectReason: null,
  pollingInterval: null,
  historyOrders: [],
  historyPage: 0,
  historyLoading: false,
  historyHasMore: true,
  partnerInfo: null,
  paymentHistory: []
};

// Toast notification function
window.showToast = (title, message, type = 'info') => {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icons = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  toast.innerHTML = `
    <div class="toast-icon">${icons[type] || icons.info}</div>
    <div class="toast-content">
      <div class="toast-title">${title}</div>
      <div class="toast-message">${message}</div>
    </div>
    <div class="toast-close" onclick="this.parentElement.remove()">√ó</div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideInRight 0.3s ease-out reverse';
    setTimeout(() => toast.remove(), 300);
  }, 5000);
};

// Request notification permission only once
async function requestNotificationPermission() {
  const notificationAsked = localStorage.getItem('notificationAsked');
  
  if (notificationAsked === 'true') {
    if (Notification.permission === 'granted') {
      await initFCM();
    }
    return;
  }
  
  if ('Notification' in window && 'serviceWorker' in navigator) {
    try {
      const permission = await Notification.requestPermission();
      localStorage.setItem('notificationAsked', 'true');
      
      if (permission === 'granted') {
        showToast('Notifications Enabled', 'You will receive order updates', 'success');
        await initFCM();
      } else {
        showToast('Notifications Disabled', 'Enable in settings to receive updates', 'warning');
      }
    } catch (error) {
      console.error('Notification permission error:', error);
      localStorage.setItem('notificationAsked', 'true');
    }
  }
}

async function initFCM() {
  try {
    await navigator.serviceWorker.register('/firebase-messaging-sw.js');
    const token = await getToken(messaging, { vapidKey: 'BJCgA4WI7ZNbRXF86toihrZbLABf0XURwSMNXxMQZXnxDJLSkk61cWQ2lJbOFzvrrkWeH-H-DZakZzMQ30adlws' });
    if (token && state.user) {
      const table = state.user.role === 'chef' ? 'chefs' : 'deliverers';
      const idField = state.user.role === 'chef' ? 'chef_id' : 'deliverer_id';
      await partnerSupabase.from(table).update({ fcm_token: token }).eq(idField, state.user.id);
    }
  } catch (e) { 
    console.error('FCM error:', e); 
  }
}

onMessage(messaging, (payload) => {
  showToast(
    payload.notification?.title || 'New Order',
    payload.notification?.body || 'You have a new update',
    'info'
  );
  loadOrders();
});

window.login = async () => {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  
  if (!username || !password) {
    showToast('Error', 'Please enter phone and password', 'error');
    return;
  }
  
  const { data: chef } = await partnerSupabase.from('chefs').select('*').eq('phone', username).single();
  if (chef && chef.password_hash === password) {
    state.user = { 
      id: chef.chef_id, 
      role: 'chef', 
      name: chef.name, 
      phone: chef.phone, 
      address: chef.address, 
      city_id: chef.city_id 
    };
    localStorage.setItem('partner', JSON.stringify(state.user));
    showApp();
    showToast('Welcome!', `Logged in as ${chef.name}`, 'success');
    return;
  }
  
  const { data: delivery } = await partnerSupabase.from('deliverers').select('*').eq('phone', username).single();
  if (delivery && delivery.phone === password) {
    state.user = { 
      id: delivery.deliverer_id, 
      role: 'delivery', 
      name: delivery.name, 
      phone: delivery.phone, 
      city_id: delivery.city_id 
    };
    localStorage.setItem('partner', JSON.stringify(state.user));
    showApp();
    showToast('Welcome!', `Logged in as ${delivery.name}`, 'success');
    return;
  }
  
  showToast('Error', 'Invalid credentials', 'error');
};

window.logout = () => {
  state.user = null;
  state.orders = [];
  state.historyOrders = [];
  state.historyPage = 0;
  state.partnerInfo = null;
  state.paymentHistory = [];
  localStorage.removeItem('partner');
  stopPolling();
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('mainApp').classList.add('hidden');
  showToast('Logged Out', 'You have been logged out', 'info');
};

function showApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('mainApp').classList.remove('hidden');
  document.getElementById('userName').textContent = state.user.name;
  document.getElementById('userRole').textContent = state.user.role === 'chef' ? 'Chef' : 'Delivery Partner';
  requestNotificationPermission();
  loadOrders();
  startPolling();
}

window.switchTab = (tab) => {
  state.tab = tab;
  document.querySelectorAll('.bottom-nav div').forEach((el, i) => {
    el.classList.toggle('active', ['orders', 'history'][i] === tab);
  });
  
  if (tab === 'orders') {
    loadOrders();
    startPolling();
  } else {
    stopPolling();
  }
  
  if (tab === 'history') {
    if (state.historyOrders.length === 0) {
      state.historyPage = 0;
      state.historyHasMore = true;
      loadHistoryOrders();
    }
    loadStats();
    loadPaymentHistory();
  }
  
  render();
};

function startPolling() {
  stopPolling();
  state.pollingInterval = setInterval(async () => {
    await checkForNewOrders();
  }, 3000);
}

function stopPolling() {
  if (state.pollingInterval) {
    clearInterval(state.pollingInterval);
    state.pollingInterval = null;
  }
}

async function checkForNewOrders() {
  if (state.tab !== 'orders') return;
  
  try {
    let newOrderIds = new Set();
    
    if (state.user.role === 'chef') {
      const { data: items } = await partnerSupabase
        .from('order_items')
        .select('orders!inner(order_id, current_status)')
        .eq('chef_id', state.user.id)
        .in('orders.current_status', ['placed', 'accepted', 'prepared', 'picked_up']);
      
      (items || []).forEach(item => {
        newOrderIds.add(item.orders.order_id);
      });
    } else {
      const { data } = await partnerSupabase
        .from('orders')
        .select('order_id')
        .eq('city_id', state.user.city_id)
        .eq('delivery_type', 'delivery')
        .in('current_status', ['prepared', 'picked_up']);
      
      (data || []).forEach(order => {
        newOrderIds.add(order.order_id);
      });
    }
    
    const hasNewOrders = Array.from(newOrderIds).some(id => !state.lastOrderIds.has(id));
    if (hasNewOrders) {
      loadOrders();
    }
    state.lastOrderIds = newOrderIds;
  } catch (err) {
    console.error('Error checking for new orders:', err);
  }
}

async function loadPartnerInfo() {
  try {
    const table = state.user.role === 'chef' ? 'chefs' : 'deliverers';
    const idField = state.user.role === 'chef' ? 'chef_id' : 'deliverer_id';
    
    const { data } = await partnerSupabase.from(table).select('*').eq(idField, state.user.id).single();
    state.partnerInfo = data;
  } catch (error) {
    console.error('Error loading partner info:', error);
  }
}

async function loadPaymentHistory() {
  try {
    const table = state.user.role === 'chef' ? 'chef_payments' : 'delivery_payments';
    const idField = state.user.role === 'chef' ? 'chef_id' : 'deliverer_id';
    
    const { data, error } = await partnerSupabase
      .from(table)
      .select('*')
      .eq(idField, state.user.id)
      .order('payment_date', { ascending: false });
    
    if (error) {
      console.error('Error loading payment history:', error);
      state.paymentHistory = [];
    } else {
      state.paymentHistory = data || [];
    }
  } catch (error) {
    console.error('Error loading payment history:', error);
    state.paymentHistory = [];
  }
}

async function loadOrders() {
  state.loading = true;
  render();
  
  try {
    if (state.user.role === 'chef') {
      const { data: items, error } = await partnerSupabase
        .from('order_items')
        .select(`
          *,
          orders!inner (
            *,
            customers (*),
            deliverers (*)
          ),
          menu (*)
        `)
        .eq('chef_id', state.user.id)
        .in('orders.current_status', ['placed', 'accepted', 'prepared', 'picked_up']);
      
      if (error) {
        console.error('Error loading chef orders:', error);
        state.orders = [];
      } else {
        const ordersMap = {};
        (items || []).forEach(item => {
          const orderId = item.orders.order_id;
          if (!ordersMap[orderId]) {
            ordersMap[orderId] = { 
              ...item.orders, 
              items: [],
              customer: item.orders.customers,
              deliverer: item.orders.deliverers
            };
          }
          ordersMap[orderId].items.push({
            ...item,
            menu: item.menu
          });
        });
        
        state.orders = Object.values(ordersMap);
      }
    } else {
      const { data, error } = await partnerSupabase
        .from('orders')
        .select(`
          *,
          order_items (
            *,
            menu (*),
            chefs (*)
          ),
          customers (*)
        `)
        .eq('city_id', state.user.city_id)
        .eq('delivery_type', 'delivery')
        .in('current_status', ['prepared', 'picked_up']);
      
      if (error) {
        console.error('Error loading delivery orders:', error);
        state.orders = [];
      } else {
        state.orders = data || [];
      }
    }
  } catch (err) {
    console.error('Exception loading orders:', err);
    state.orders = [];
  }
  
  state.loading = false;
  render();
}

async function loadStats() {
  await loadPartnerInfo();
  
  const now = new Date();
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
  
  if (state.user.role === 'chef') {
    const { data: orders } = await partnerSupabase.from('orders')
      .select('*, order_items!inner(*)')
      .eq('order_items.chef_id', state.user.id)
      .eq('current_status', 'delivered')
      .gte('created_at', startOfMonth);
    
    let totalFoodRevenue = 0;
    let totalDeliveryRevenue = 0;
    let selfDeliveryCount = 0;
    
    (orders || []).forEach(order => {
      const deliveryFee = order.delivery_type === 'delivery' ? parseFloat(order.delivery_amount || 50) : 0;
      const foodAmount = parseFloat(order.total_amount) - deliveryFee;
      
      totalFoodRevenue += foodAmount;
      
      if (order.delivery_type === 'delivery' && order.delivered_by_chef_id === state.user.id) {
        totalDeliveryRevenue += 50;
        selfDeliveryCount++;
      }
    });
    
    const platformFee = selfDeliveryCount * 10;
    const netDeliveryRevenue = totalDeliveryRevenue - platformFee;
    
    // Calculate total paid from payment history
    const currentMonthPayments = state.paymentHistory.filter(p => {
      const paymentDate = new Date(p.payment_date);
      return paymentDate >= new Date(startOfMonth);
    });
    
    const totalPaid = currentMonthPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
    const pendingFee = platformFee - totalPaid;
    
    state.stats = {
      foodRevenue: totalFoodRevenue.toFixed(2),
      deliveryRevenue: totalDeliveryRevenue.toFixed(2),
      netDeliveryRevenue: netDeliveryRevenue.toFixed(2),
      platformFee: platformFee.toFixed(2),
      totalPaid: totalPaid.toFixed(2),
      pendingFee: Math.max(0, pendingFee).toFixed(2),
      totalOrders: (orders || []).length,
      selfDeliveryCount: selfDeliveryCount,
      isPaid: pendingFee <= 0
    };
  } else {
    const { data: orders } = await partnerSupabase.from('orders')
      .select('*')
      .eq('delivery_person_id', state.user.id)
      .eq('current_status', 'delivered')
      .gte('created_at', startOfMonth);
    
    const deliveryCount = (orders || []).length;
    const totalCollected = deliveryCount * 50;
    const platformFee = deliveryCount * 10;
    const profit = deliveryCount * 40;
    
    // Calculate total paid from payment history
    const currentMonthPayments = state.paymentHistory.filter(p => {
      const paymentDate = new Date(p.payment_date);
      return paymentDate >= new Date(startOfMonth);
    });
    
    const totalPaid = currentMonthPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
    const pendingFee = platformFee - totalPaid;
    
    state.stats = {
      totalCollected: totalCollected.toFixed(2),
      platformFee: platformFee.toFixed(2),
      totalPaid: totalPaid.toFixed(2),
      pendingFee: Math.max(0, pendingFee).toFixed(2),
      profit: profit.toFixed(2),
      completed: deliveryCount,
      isPaid: pendingFee <= 0
    };
  }
  render();
}

async function loadHistoryOrders() {
  if (state.historyLoading || !state.historyHasMore) return;
  
  state.historyLoading = true;
  render();
  
  try {
    const limit = 5;
    const offset = state.historyPage * limit;
    
    if (state.user.role === 'chef') {
      const { data, error } = await partnerSupabase
        .from('orders')
        .select(`
          *,
          customers(*),
          order_items!inner(*, menu(*))
        `)
        .eq('order_items.chef_id', state.user.id)
        .eq('current_status', 'delivered')
        .order('created_at', { ascending: false })
        .range(offset, offset + limit - 1);
      
      if (error) throw error;
      
      state.historyOrders.push(...(data || []));
      state.historyHasMore = (data?.length || 0) === limit;
    } else {
      const { data, error } = await partnerSupabase
        .from('orders')
        .select(`
          *,
          customers(*),
          order_items(*, chefs(*), menu(*))
        `)
        .eq('delivery_person_id', state.user.id)
        .eq('current_status', 'delivered')
        .order('created_at', { ascending: false })
        .range(offset, offset + limit - 1);
      
      if (error) throw error;
      
      state.historyOrders.push(...(data || []));
      state.historyHasMore = (data?.length || 0) === limit;
    }
    
    state.historyPage++;
  } catch (error) {
    console.error('Load history error:', error);
    showToast('Error', 'Failed to load order history', 'error');
  } finally {
    state.historyLoading = false;
    render();
  }
}

window.loadMoreHistory = () => {
  loadHistoryOrders();
};

window.acceptOrder = async (orderId, selfDeliver = false) => {
  if (selfDeliver) {
    await partnerSupabase.from('orders').update({ 
      current_status: 'picked_up',
      delivered_by_chef_id: state.user.id
    }).eq('order_id', orderId);
    
    await partnerSupabase.from('order_status_history').insert({ 
      order_id: orderId, 
      status: 'accepted', 
      changed_by: 'chef' 
    });
    
    await partnerSupabase.from('order_status_history').insert({ 
      order_id: orderId, 
      status: 'picked_up', 
      changed_by: 'chef' 
    });
    
    showToast('Success', 'Order accepted! Ready to deliver', 'success');
  } else {
    await partnerSupabase.from('orders').update({ current_status: 'accepted' }).eq('order_id', orderId);
    await partnerSupabase.from('order_status_history').insert({ 
      order_id: orderId, 
      status: 'accepted', 
      changed_by: 'chef' 
    });
    showToast('Success', 'Order accepted!', 'success');
  }
  
  loadOrders();
};

window.showRejectModal = (orderId) => {
  state.rejectingOrderId = orderId;
  state.selectedRejectReason = null;
  document.getElementById('rejectModal').classList.add('show');
  document.getElementById('confirmRejectBtn').disabled = true;
  document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
};

window.closeRejectModal = () => {
  document.getElementById('rejectModal').classList.remove('show');
  state.rejectingOrderId = null;
  state.selectedRejectReason = null;
};

window.selectReason = (reason) => {
  state.selectedRejectReason = reason;
  document.querySelectorAll('.reason-option').forEach(opt => opt.classList.remove('selected'));
  event.target.classList.add('selected');
  document.getElementById('confirmRejectBtn').disabled = false;
};

window.confirmReject = async () => {
  if (!state.rejectingOrderId || !state.selectedRejectReason) return;
  
  await partnerSupabase.from('orders').update({ current_status: 'cancelled' }).eq('order_id', state.rejectingOrderId);
  await partnerSupabase.from('order_status_history').insert({ 
    order_id: state.rejectingOrderId, 
    status: 'cancelled', 
    changed_by: 'chef' 
  });
  closeRejectModal();
  showToast('Order Rejected', `Reason: ${state.selectedRejectReason}`, 'warning');
  loadOrders();
};

window.markDone = async (orderId) => {
  await partnerSupabase.from('orders').update({ current_status: 'prepared' }).eq('order_id', orderId);
  await partnerSupabase.from('order_status_history').insert({ 
    order_id: orderId, 
    status: 'prepared', 
    changed_by: 'chef' 
  });
  showToast('Success', 'Order marked as ready!', 'success');
  loadOrders();
};

window.markSelfPickupDelivered = async (orderId) => {
  await partnerSupabase.from('orders').update({ current_status: 'delivered' }).eq('order_id', orderId);
  await partnerSupabase.from('order_status_history').insert({ 
    order_id: orderId, 
    status: 'delivered', 
    changed_by: 'chef' 
  });
  showToast('Success', 'Order delivered!', 'success');
  loadOrders();
};

window.acceptDelivery = async (orderId) => {
  await partnerSupabase.from('orders').update({ delivery_person_id: state.user.id }).eq('order_id', orderId);
  showToast('Success', 'Delivery accepted!', 'success');
  loadOrders();
};

window.acceptChefDelivery = async (orderId) => {
  await partnerSupabase.from('orders').update({ 
    current_status: 'picked_up',
    delivered_by_chef_id: state.user.id 
  }).eq('order_id', orderId);
  
  await partnerSupabase.from('order_status_history').insert({ 
    order_id: orderId, 
    status: 'picked_up', 
    changed_by: 'chef' 
  });
  
  showToast('Success', 'You will deliver this order!', 'success');
  loadOrders();
};

window.markPickedUp = async (orderId) => {
  await partnerSupabase.from('orders').update({ current_status: 'picked_up' }).eq('order_id', orderId);
  await partnerSupabase.from('order_status_history').insert({ 
    order_id: orderId, 
    status: 'picked_up', 
    changed_by: state.user.role === 'chef' ? 'chef' : 'delivery'
  });
  showToast('Success', 'Order picked up!', 'success');
  loadOrders();
};

window.markDelivered = async (orderId) => {
  await partnerSupabase.from('orders').update({ current_status: 'delivered' }).eq('order_id', orderId);
  await partnerSupabase.from('order_status_history').insert({ 
    order_id: orderId, 
    status: 'delivered', 
    changed_by: state.user.role === 'chef' ? 'chef' : 'delivery'
  });
  showToast('Success', 'Order delivered! Payment confirmed', 'success');
  loadOrders();
};

window.payPlatformFee = () => {
  const WHATSAPP_NUMBER = '917876602575';
  const amount = parseFloat(state.stats.pendingFee || 0);
  const partnerType = state.user.role === 'chef' ? 'Chef' : 'Delivery Partner';
  
  if (amount === 0) {
    showToast('Info', 'No pending platform fee', 'info');
    return;
  }
  
  const message = `Hey! I'm ${state.user.name} (${partnerType}). I'm paying ‚Çπ${amount.toFixed(2)} platform fee for this month. Please confirm and update my payment record. Thank you!`;
  const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
  
  window.open(whatsappUrl, '_blank');
};

function render() {
  const content = document.getElementById('appContent');
  
  if (state.tab === 'orders') {
    let html = '<div class="container">';
    
    if (state.loading) {
      html += '<div class="shimmer"></div><div class="shimmer"></div><div class="shimmer"></div>';
    } else if (state.user.role === 'chef') {
      const unanswered = state.orders.filter(o => o.current_status === 'placed');
      const current = state.orders.filter(o => o.current_status === 'accepted');
      const prepared = state.orders.filter(o => o.current_status === 'prepared');
      const selfDelivering = state.orders.filter(o => o.current_status === 'picked_up' && o.delivered_by_chef_id === state.user.id);
      
      html += `<div class="section">
        <h3>
          <span><span class="status-indicator status-new"></span>New Orders</span>
          ${unanswered.length > 0 ? `<span class="badge-count">${unanswered.length}</span>` : ''}
        </h3>`;
      
      if (unanswered.length === 0) {
        html += '<div class="empty-state" style="padding: 20px;"><p>No new orders</p></div>';
      } else {
        unanswered.forEach(order => {
          const deliveryFee = order.delivery_type === 'delivery' ? 50 : 0;
          const foodAmount = parseFloat(order.total_amount) - deliveryFee;
          const customerPayment = parseFloat(order.total_amount);
          
          html += `<div class="order-card new-order">
            <h4>Order #${order.order_id}</h4>
            <div class="items" style="font-size: 16px; font-weight: 600; margin: 12px 0;">
              ${order.items.map(i => `<div>‚Ä¢ ${i.menu?.item_name || 'Item'} x${i.quantity}</div>`).join('')}
            </div>
            <div class="address">
              üìç ${order.customer?.address || 'No address'}
            </div>
            <div class="meta">
              ${order.customer?.name || 'Customer'} ‚Ä¢ ${order.customer?.phone || ''}
              <a href="tel:${order.customer?.phone || ''}" class="call-btn">üìû Call</a>
            </div>
            
            ${order.delivery_type === 'delivery' ? `
              <div class="payment-breakdown">
                <div class="row">
                  <span class="label">Food Cost:</span>
                  <span>‚Çπ${foodAmount.toFixed(2)}</span>
                </div>
                <div class="row">
                  <span class="label">Delivery Fee:</span>
                  <span>‚Çπ50.00</span>
                </div>
                <div class="row total">
                  <span>üí∞ Collect from Customer:</span>
                  <span>‚Çπ${customerPayment.toFixed(2)}</span>
                </div>
              </div>
              <div class="meta" style="color: var(--secondary); font-size: 12px; margin-top: 8px;">
                üìù Note: Platform fee ‚Çπ10 will be deducted later (if you deliver)
              </div>
            ` : `
              <div class="amount highlight">üí∞ Collect: ‚Çπ${foodAmount.toFixed(2)}</div>
            `}
            
            <div class="meta" style="margin-top: 12px;">
              Delivery: ${order.delivery_type === 'delivery' ? 'üõµ Home Delivery' : 'üèÉ Self Pickup'}
            </div>
            <div class="actions">
              <button class="danger" onclick="showRejectModal(${order.order_id})">‚ùå Reject</button>
              ${order.delivery_type === 'delivery' ? 
                `<button class="success" onclick="acceptOrder(${order.order_id})">‚úì Accept (wait for rider)</button>
                <button class="warning" onclick="acceptOrder(${order.order_id}, true)">üöó Accept & I'll Deliver</button>` :
                `<button class="success" onclick="acceptOrder(${order.order_id})">‚úì Accept</button>`
              }
            </div>
          </div>`;
        });
      }
      html += '</div>';
      
      html += `<div class="section">
        <h3>
          <span><span class="status-indicator status-preparing"></span>Preparing</span>
          ${current.length > 0 ? `<span class="badge-count">${current.length}</span>` : ''}
        </h3>`;
      
      if (current.length === 0) {
        html += '<div class="empty-state" style="padding: 20px;"><p>No orders being prepared</p></div>';
      } else {
        current.forEach(order => {
          const deliveryFee = order.delivery_type === 'delivery' ? 50 : 0;
          const foodAmount = parseFloat(order.total_amount) - deliveryFee;
          
          html += `<div class="order-card">
            <h4>Order #${order.order_id}</h4>
            <div class="items" style="font-size: 16px; font-weight: 600;">
              ${order.items.map(i => `<div>‚Ä¢ ${i.menu?.item_name || 'Item'} x${i.quantity}</div>`).join('')}
            </div>
            <div class="amount">Food: ‚Çπ${foodAmount.toFixed(2)}</div>
            <div class="actions">
              <button class="success" onclick="markDone(${order.order_id})">‚úì Mark as Ready</button>
            </div>
          </div>`;
        });
      }
      html += '</div>';
      
      if (prepared.length > 0) {
        html += `<div class="section">
          <h3>
            <span><span class="status-indicator status-ready"></span>Ready for Pickup</span>
            <span class="badge-count">${prepared.length}</span>
          </h3>`;
        
        prepared.forEach(order => {
          const isWaitingDelivery = order.delivery_type === 'delivery' && !order.delivery_person_id;
          const isSelfPickup = order.delivery_type === 'self_pickup';
          const deliveryFee = order.delivery_type === 'delivery' ? 50 : 0;
          const foodAmount = parseFloat(order.total_amount) - deliveryFee;
          
          html += `<div class="order-card">
            <h4>Order #${order.order_id}</h4>
            <div class="items">
              ${order.items.map(i => `<div>‚Ä¢ ${i.menu?.item_name || 'Item'} x${i.quantity}</div>`).join('')}
            </div>
            <div class="amount">Food: ‚Çπ${foodAmount.toFixed(2)}</div>
            ${isWaitingDelivery ? `
              <div class="meta" style="color: var(--warning); font-weight: 600;">‚è≥ Waiting for delivery partner</div>
              <div class="actions">
                <button class="warning" onclick="acceptChefDelivery(${order.order_id})">üöó I'll Deliver This</button>
              </div>
            ` : ''}
            ${isSelfPickup ? `
              <div class="meta" style="color: var(--success); font-weight: 600;">üèÉ Customer will pickup</div>
              <div class="actions">
                <button class="success" onclick="markSelfPickupDelivered(${order.order_id})">‚úì Handed Over to Customer</button>
              </div>
            ` : ''}
          </div>`;
        });
        html += '</div>';
      }
      
      if (selfDelivering.length > 0) {
        html += `<div class="section">
          <h3>
            <span>üöó My Deliveries</span>
            <span class="badge-count">${selfDelivering.length}</span>
          </h3>`;
        
        selfDelivering.forEach(order => {
          const deliveryFee = 50;
          const foodAmount = parseFloat(order.total_amount) - deliveryFee;
          const customerPayment = parseFloat(order.total_amount);
          
          html += `<div class="order-card payment-pending">
            <h4>Order #${order.order_id}</h4>
            <div class="address" style="font-size: 17px;">
              üìç ${order.customer?.address || 'Delivery address'}
            </div>
            <div class="meta">
              ${order.customer?.name || 'Customer'}
              <a href="tel:${order.customer?.phone || ''}" class="call-btn">üìû Call</a>
            </div>
            <div class="items">
              ${order.items.map(i => `<div>‚Ä¢ ${i.menu?.item_name || 'Item'} x${i.quantity}</div>`).join('')}
            </div>
            
            <div class="payment-breakdown">
              <div class="row">
                <span class="label">Food Cost:</span>
                <span>‚Çπ${foodAmount.toFixed(2)}</span>
              </div>
              <div class="row">
                <span class="label">Delivery Fee:</span>
                <span>‚Çπ50.00</span>
              </div>
              <div class="row total">
                <span>üí∞ Collect from Customer:</span>
                <span>‚Çπ${customerPayment.toFixed(2)}</span>
              </div>
            </div>
            
            <div class="meta" style="font-weight: 600; color: var(--secondary); margin-top: 8px; font-size: 13px;">
              üìù You keep: Food (‚Çπ${foodAmount.toFixed(2)}) + ‚Çπ40 delivery = ‚Çπ${(foodAmount + 40).toFixed(2)}<br>
              üìù Platform fee: ‚Çπ10 (pay later)
            </div>
            
            <div class="actions">
              <button class="success" onclick="markDelivered(${order.order_id})" style="width: 100%;">
                ‚úì Payment Received (‚Çπ${customerPayment.toFixed(2)})
              </button>
            </div>
          </div>`;
        });
        html += '</div>';
      }
      
      if (unanswered.length === 0 && current.length === 0 && prepared.length === 0 && selfDelivering.length === 0) {
        html += '<div class="empty-state"><p>No active orders</p></div>';
      }
      
    } else {
      // Delivery person view
      const available = state.orders.filter(o => o.current_status === 'prepared' && !o.delivery_person_id);
      const accepted = state.orders.filter(o => o.current_status === 'prepared' && o.delivery_person_id === state.user.id);
      const current = state.orders.filter(o => o.current_status === 'picked_up' && o.delivery_person_id === state.user.id);
      
      html += `<div class="section">
        <h3>
          <span><span class="status-indicator status-new"></span>Available Deliveries</span>
          ${available.length > 0 ? `<span class="badge-count">${available.length}</span>` : ''}
        </h3>`;
      
      if (available.length === 0) {
        html += '<div class="empty-state" style="padding: 20px;"><p>No available deliveries</p></div>';
      } else {
        available.forEach(order => {
          const chefAddress = order.order_items[0]?.chefs?.address || 'Chef location';
          html += `<div class="order-card new-order">
            <h4>Order #${order.order_id}</h4>
            <div class="address" style="font-size: 17px;">
              üìç Pickup: ${chefAddress}
            </div>
            
            <div class="payment-breakdown">
              <div class="row">
                <span class="label">You collect from customer:</span>
                <span>‚Çπ50.00</span>
              </div>
              <div class="row">
                <span class="label">Platform fee (pay later):</span>
                <span style="color: var(--danger);">-‚Çπ10.00</span>
              </div>
              <div class="row total">
                <span>üí∞ Your Profit:</span>
                <span style="color: var(--success);">‚Çπ40.00</span>
              </div>
            </div>
            
            <div class="actions">
              <button class="success" onclick="acceptDelivery(${order.order_id})">‚úì Accept Delivery</button>
            </div>
          </div>`;
        });
      }
      html += '</div>';
      
      if (accepted.length > 0) {
        html += `<div class="section">
          <h3>
            <span><span class="status-indicator status-preparing"></span>Being Prepared</span>
            <span class="badge-count">${accepted.length}</span>
          </h3>`;
        
        accepted.forEach(order => {
          const chefAddress = order.order_items[0]?.chefs?.address || 'Chef location';
          const chefPhone = order.order_items[0]?.chefs?.phone || '';
          html += `<div class="order-card">
            <h4>Order #${order.order_id}</h4>
            <div class="address">
              üìç ${chefAddress}
              <a href="tel:${chefPhone}" class="call-btn">üìû Call Chef</a>
            </div>
            <div class="meta" style="font-weight: 600;">‚è≥ Chef is preparing the order...</div>
            <div class="amount">You'll earn: ‚Çπ40</div>
            <div class="actions">
              <button class="success" onclick="markPickedUp(${order.order_id})">‚úì Picked Up from Chef</button>
            </div>
          </div>`;
        });
        html += '</div>';
      }
      
      html += `<div class="section">
        <h3>
          <span><span class="status-indicator status-ready"></span>Active Deliveries</span>
          ${current.length > 0 ? `<span class="badge-count">${current.length}</span>` : ''}
        </h3>`;
      
      if (current.length === 0) {
        html += '<div class="empty-state" style="padding: 20px;"><p>No active deliveries</p></div>';
      } else {
        current.forEach(order => {
          const deliveryFee = 50;
          const foodAmount = parseFloat(order.total_amount) - deliveryFee;
          const customerPayment = parseFloat(order.total_amount);
          const chefPhone = order.order_items[0]?.chefs?.phone || '';
          
          html += `<div class="order-card payment-pending">
            <h4>Order #${order.order_id}</h4>
            <div class="address" style="font-size: 17px;">
              üìç ${order.customers?.address || 'Delivery address'}
            </div>
            <div class="meta">
              ${order.customers?.name || 'Customer'}
              <a href="tel:${order.customers?.phone}" class="call-btn">üìû Call</a>
            </div>
            
            <div class="payment-breakdown">
              <div class="row total">
                <span>üí∞ Collect from Customer:</span>
                <span style="color: var(--success);">‚Çπ${customerPayment.toFixed(2)}</span>
              </div>
              <div class="row">
                <span style="color: var(--danger);">üí∏ Pay Chef (food cost):</span>
                <span style="color: var(--danger);">‚Çπ${foodAmount.toFixed(2)}</span>
              </div>
              <div class="row">
                <span class="label">You keep (‚Çπ50 - ‚Çπ10 platform fee):</span>
                <span style="color: var(--success); font-weight: 700;">‚Çπ40.00</span>
              </div>
            </div>
            
            <div class="meta" style="margin-top: 8px;">
              Chef: ${order.order_items[0]?.chefs?.name || 'Chef'}
              <a href="tel:${chefPhone}" class="call-btn">üìû Call</a>
            </div>
            
            <div class="actions">
              <button class="success" onclick="markDelivered(${order.order_id})">‚úì Delivered & Paid Chef</button>
            </div>
          </div>`;
        });
      }
      html += '</div>';
    }
    
    html += '</div>';
    content.innerHTML = html;
  }
  
  if (state.tab === 'history') {
    let html = '<div class="container">';
    html += `<div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid var(--border);">
      <h3 style="margin-bottom: 12px;">Profile</h3>
      <label>Name</label>
      <input value="${state.user.name}" readonly>
      <label>Phone</label>
      <input value="${state.user.phone}" readonly>
      ${state.user.address ? `<label>Address</label><textarea readonly rows="2">${state.user.address}</textarea>` : ''}
    </div>`;
    
    html += '<h3 style="margin: 24px 0 16px; font-size: 20px;">This Month\'s Summary</h3>';
    
    if (state.user.role === 'chef') {
      html += `
        <div class="stat-box">
          <div class="label">Food Revenue (100% yours)</div>
          <div class="value">‚Çπ${state.stats.foodRevenue || '0.00'}</div>
        </div>
        <div class="stat-box">
          <div class="label">Delivery Fees Collected</div>
          <div class="value">‚Çπ${state.stats.deliveryRevenue || '0.00'}</div>
          <div class="meta" style="margin-top: 8px;">${state.stats.selfDeliveryCount || 0} self-deliveries √ó ‚Çπ50</div>
        </div>
        
        <div class="fee-summary">
          <div class="fee-card paid-card">
            <div class="fee-label">Already Paid</div>
            <div class="fee-value">‚Çπ${state.stats.totalPaid || '0.00'}</div>
          </div>
          <div class="fee-card pending-card">
            <div class="fee-label">Pending Payment</div>
            <div class="fee-value">‚Çπ${state.stats.pendingFee || '0.00'}</div>
          </div>
        </div>
        
        <div class="stat-box ${parseFloat(state.stats.pendingFee || 0) === 0 ? 'paid' : 'pending'}">
          <div class="label">Platform Fee Status</div>
          <div class="value">${parseFloat(state.stats.pendingFee || 0) === 0 ? '‚úÖ All Paid' : '‚Çπ' + (state.stats.pendingFee || '0.00') + ' Pending'}</div>
          ${parseFloat(state.stats.pendingFee || 0) > 0 ? `<div class="meta" style="margin-top: 8px;">Total fee: ‚Çπ${state.stats.platformFee || '0.00'} | Paid: ‚Çπ${state.stats.totalPaid || '0.00'}</div>` : `<div class="meta" style="margin-top: 8px; color: var(--success);">Thank you for payment!</div>`}
        </div>
        
        <div class="stat-box">
          <div class="label">Net Delivery Earnings</div>
          <div class="value" style="color: var(--success);">‚Çπ${state.stats.netDeliveryRevenue || '0.00'}</div>
          <div class="meta" style="margin-top: 8px;">‚Çπ40 per delivery after platform fee</div>
        </div>
        <div class="stat-box">
          <div class="label">Total Orders Completed</div>
          <div class="value">${state.stats.totalOrders || 0}</div>
        </div>`;
        
      if (state.paymentHistory.length > 0) {
        html += `
          <div class="payment-history">
            <h4 style="margin-bottom: 12px; font-size: 16px;">Payment History</h4>`;
        
        state.paymentHistory.forEach(payment => {
          const paymentDate = new Date(payment.payment_date).toLocaleDateString('en-IN', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
          });
          
          html += `
            <div class="history-item">
              <span class="history-label">üìÖ ${paymentDate}</span>
              <span class="history-value">‚Çπ${parseFloat(payment.amount || 0).toFixed(2)}</span>
            </div>`;
        });
        
        html += `</div>`;
      }
      
      html += `
        ${parseFloat(state.stats.pendingFee || 0) > 0 ? `
          <button style="width: 100%; margin-top: 12px;" onclick="payPlatformFee()">
            üí¨ Pay Pending Fee ‚Çπ${state.stats.pendingFee || '0.00'} via WhatsApp
          </button>
        ` : `
          <div style="text-align: center; padding: 16px; margin-top: 12px; background: #e8f5e9; border-radius: 8px; color: var(--success); font-weight: 600;">
            ‚úÖ All platform fees paid for this month!
          </div>
        `}`;
    } else {
      html += `
        <div class="stat-box">
          <div class="label">Total Delivery Fees Collected</div>
          <div class="value">‚Çπ${state.stats.totalCollected || '0.00'}</div>
          <div class="meta" style="margin-top: 8px;">${state.stats.completed || 0} deliveries √ó ‚Çπ50</div>
        </div>
        
        <div class="fee-summary">
          <div class="fee-card paid-card">
            <div class="fee-label">Already Paid</div>
            <div class="fee-value">‚Çπ${state.stats.totalPaid || '0.00'}</div>
          </div>
          <div class="fee-card pending-card">
            <div class="fee-label">Pending Payment</div>
            <div class="fee-value">‚Çπ${state.stats.pendingFee || '0.00'}</div>
          </div>
        </div>
        
        <div class="stat-box ${parseFloat(state.stats.pendingFee || 0) === 0 ? 'paid' : 'pending'}">
          <div class="label">Platform Fee Status</div>
          <div class="value">${parseFloat(state.stats.pendingFee || 0) === 0 ? '‚úÖ All Paid' : '‚Çπ' + (state.stats.pendingFee || '0.00') + ' Pending'}</div>
          ${parseFloat(state.stats.pendingFee || 0) > 0 ? `<div class="meta" style="margin-top: 8px;">Total fee: ‚Çπ${state.stats.platformFee || '0.00'} | Paid: ‚Çπ${state.stats.totalPaid || '0.00'}</div>` : `<div class="meta" style="margin-top: 8px; color: var(--success);">Thank you for payment!</div>`}
        </div>
        
        <div class="stat-box">
          <div class="label">Your Net Profit</div>
          <div class="value" style="color: var(--success);">‚Çπ${state.stats.profit || '0.00'}</div>
          <div class="meta" style="margin-top: 8px;">‚Çπ40 per delivery after platform fee</div>
        </div>
        <div class="stat-box">
          <div class="label">Deliveries Completed</div>
          <div class="value">${state.stats.completed || 0}</div>
        </div>`;
        
      if (state.paymentHistory.length > 0) {
        html += `
          <div class="payment-history">
            <h4 style="margin-bottom: 12px; font-size: 16px;">Payment History</h4>`;
        
        state.paymentHistory.forEach(payment => {
          const paymentDate = new Date(payment.payment_date).toLocaleDateString('en-IN', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
          });
          
          html += `
            <div class="history-item">
              <span class="history-label">üìÖ ${paymentDate}</span>
              <span class="history-value">‚Çπ${parseFloat(payment.amount || 0).toFixed(2)}</span>
            </div>`;
        });
        
        html += `</div>`;
      }
      
      html += `
        ${parseFloat(state.stats.pendingFee || 0) > 0 ? `
          <button style="width: 100%; margin-top: 12px;" onclick="payPlatformFee()">
            üí¨ Pay Pending Fee ‚Çπ${state.stats.pendingFee || '0.00'} via WhatsApp
          </button>
        ` : `
          <div style="text-align: center; padding: 16px; margin-top: 12px; background: #e8f5e9; border-radius: 8px; color: var(--success); font-weight: 600;">
            ‚úÖ All platform fees paid for this month!
          </div>
        `}`;
    }
    
    // Order History Section
    html += '<h3 style="margin: 32px 0 16px; font-size: 20px;">Order History</h3>';
    
    if (state.historyOrders.length === 0 && !state.historyLoading) {
      html += '<div class="empty-state"><p>No completed orders yet</p></div>';
    } else {
      state.historyOrders.forEach(order => {
        const deliveryFee = order.delivery_type === 'delivery' ? 50 : 0;
        const foodAmount = parseFloat(order.total_amount) - deliveryFee;
        
        let displayAmount;
        if (state.user.role === 'chef') {
          if (order.delivered_by_chef_id === state.user.id) {
            displayAmount = foodAmount + 40;
          } else {
            displayAmount = foodAmount;
          }
        } else {
          displayAmount = 40;
        }
        
        const orderDate = new Date(order.created_at).toLocaleDateString('en-IN', {
          day: 'numeric',
          month: 'short',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        html += `<div class="order-card">
          <h4>Order #${order.order_id}</h4>
          <div class="meta">üìÖ ${orderDate}</div>
          ${state.user.role === 'chef' ? `
            <div class="items">
              ${order.order_items.map(i => `<div>‚Ä¢ ${i.menu?.item_name || 'Item'} x${i.quantity}</div>`).join('')}
            </div>
            ${order.delivered_by_chef_id === state.user.id ? `
              <div class="meta" style="color: var(--success); font-weight: 600;">üöó You delivered this order</div>
            ` : ''}
          ` : ''}
          <div class="amount">‚Çπ${displayAmount.toFixed(2)}</div>
          <div class="meta" style="color: var(--success); font-weight: 600;">‚úì Delivered</div>
        </div>`;
      });
      
      if (state.historyHasMore) {
        html += `<div class="load-more">
          <button onclick="loadMoreHistory()" ${state.historyLoading ? 'disabled' : ''}>
            ${state.historyLoading ? 'Loading...' : 'Load More'}
          </button>
        </div>`;
      }
    }
    
    html += '</div>';
    content.innerHTML = html;
  }
}

// Auto-login if user is stored
if (state.user) {
  showApp();
}
</script>

</body>
</html>